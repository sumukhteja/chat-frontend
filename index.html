<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>Random Chat</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap');
    
    html {
      height: 100%;
      width: 100%;
      overflow: hidden;
    }
    
    body { 
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
      background: #0a0a0a;
      min-height: 100vh;
      height: 100vh;
      width: 100vw;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0;
      margin: 0;
      color: #ffffff;
      overflow: hidden;
      -webkit-text-size-adjust: 100%;
      -webkit-overflow-scrolling: touch;
      position: fixed;
      top: 0;
      left: 0;
    }
    
    /* Samsung S24 Specific Optimizations */
    @media screen and (device-width: 360px) and (device-height: 780px) and (-webkit-device-pixel-ratio: 3) {
      body {
        height: 100vh;
        height: -webkit-fill-available;
      }
      
      .chat-container {
        height: 100vh !important;
        height: -webkit-fill-available !important;
        max-height: none !important;
        border-radius: 0 !important;
        width: 100vw !important;
        max-width: 100vw !important;
      }
      
      .main-container {
        height: 100vh;
        height: -webkit-fill-available;
      }
    }
    
    /* Chrome Mobile Optimizations for Perfect Fit */
    @supports (-webkit-touch-callout: none) {
      body {
        height: 100vh;
        height: -webkit-fill-available;
        min-height: -webkit-fill-available;
      }
      
      .main-container {
        height: 100vh;
        height: -webkit-fill-available;
        min-height: -webkit-fill-available;
      }
      
      @media (max-width: 768px) {
        .chat-container {
          height: 100vh !important;
          height: -webkit-fill-available !important;
          min-height: -webkit-fill-available !important;
        }
      }
    }
    
    /* Android Chrome Specific */
    @media screen and (-webkit-min-device-pixel-ratio: 1) {
      @supports (env(safe-area-inset-top)) {
        .chat-container {
          padding-top: env(safe-area-inset-top);
          padding-bottom: env(safe-area-inset-bottom);
        }
      }
    }
    
    .main-container {
      display: flex;
      width: 100%;
      height: 100vh;
      justify-content: center;
      align-items: center;
      background: #0a0a0a;
    }
    
    .chat-container {
      background: #ffffff;
      width: 420px;
      max-width: 95vw;
      height: 85vh;
      max-height: 700px;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12);
      border-radius: 16px;
      position: relative;
      border: 1px solid #e5e7eb;
    }
    
    /* Profile Setup - Modern Design */
    .profile-setup {
      padding: 24px;
      text-align: center;
      flex: 1;
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
      padding-top: 60px;
      background: #ffffff;
    }
    
    .profile-setup h3 { 
      margin-bottom: 32px; 
      color: #1f2937; 
      font-weight: 600; 
      font-size: 24px;
      letter-spacing: -0.025em;
    }
    
    .form-group { 
      margin-bottom: 24px; 
      text-align: left; 
    }
    
    .form-group label { 
      display: block; 
      margin-bottom: 8px; 
      font-weight: 500; 
      color: #374151; 
      font-size: 14px;
    }
    
    .form-group input {
      width: 100%;
      padding: 16px;
      border: 2px solid #e5e7eb;
      border-radius: 12px;
      font-size: 16px;
      font-family: 'Inter', sans-serif;
      transition: all 0.2s ease;
      background: #ffffff;
      color: #1f2937;
      font-weight: 400;
    }
    
    .form-group input:focus {
      outline: none;
      border-color: #10b981;
      box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
    }
    
    .gender-buttons {
      display: flex;
      gap: 12px;
      margin-top: 8px;
    }
    
    .gender-btn {
      flex: 1;
      padding: 16px;
      border: 2px solid #e5e7eb;
      background: #ffffff;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.2s ease;
      font-family: 'Inter', sans-serif;
      font-weight: 500;
      color: #374151;
      font-size: 16px;
      -webkit-tap-highlight-color: transparent;
    }
    
    .gender-btn:hover {
      border-color: #d1d5db;
      background: #f9fafb;
    }
    
    .gender-btn.selected {
      background: #10b981;
      color: white;
      border-color: #10b981;
    }
    
    .start-btn {
      width: 100%;
      padding: 16px;
      background: #10b981;
      color: white;
      border: none;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      margin-top: 24px;
      font-family: 'Inter', sans-serif;
      transition: all 0.2s ease;
      -webkit-tap-highlight-color: transparent;
    }
    
    .start-btn:hover {
      background: #059669;
      transform: translateY(-1px);
    }
    
    .start-btn:disabled {
      background: #d1d5db;
      cursor: not-allowed;
      transform: none;
    }
    
    /* Stats Panel - Minimal Design */
    .stats-panel {
      background: #f8fafc;
      padding: 16px 20px;
      border-bottom: 1px solid #e5e7eb;
      font-size: 13px;
      color: #6b7280;
    }
    
    .stats-row { 
      display: flex; 
      justify-content: space-between; 
      margin-bottom: 4px; 
    }
    
    .stats-row:last-child { 
      margin-bottom: 0; 
    }
    
    .stats-label { 
      font-weight: 500; 
      color: #374151; 
    }
    
    /* Main Screen Layout */
    .main-screen {
      flex: 1;
      display: flex;
      flex-direction: column;
      min-height: 0;
      overflow: hidden;
    }
    
    .waiting-screen {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      padding: 60px 24px 40px 24px;
      text-align: center;
      background: #ffffff;
    }
    
    .waiting-screen h3 { 
      color: #1f2937; 
      margin-bottom: 16px; 
      font-weight: 600;
      font-size: 20px;
    }
    
    .waiting-screen p { 
      color: #6b7280; 
      font-size: 14px;
      line-height: 1.5;
    }
    
    .spinner {
      border: 3px solid #e5e7eb;
      border-top: 3px solid #10b981;
      border-radius: 50%;
      width: 32px;
      height: 32px;
      animation: spin 1s linear infinite;
      margin-bottom: 24px;
    }
    
    @keyframes spin { 
      0% { transform: rotate(0deg); } 
      100% { transform: rotate(360deg); } 
    }
    
    /* Chat Screen - WhatsApp Style */
    .matched-screen {
      flex: 1;
      display: flex;
      flex-direction: column;
      height: 100%;
      min-height: 0;
      overflow: hidden;
      background: #f0f2f5;
    }
    
    /* Chat Header - WhatsApp Style */
    .chat-header {
      background: #ffffff;
      border-bottom: 1px solid #e5e7eb;
      padding: 16px 20px;
      display: flex;
      align-items: center;
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
      flex-shrink: 0;
      min-height: 70px;
    }
    
    .partner-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: linear-gradient(45deg, #10b981 0%, #059669 100%);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 16px;
      margin-right: 12px;
      flex-shrink: 0;
    }
    
    .partner-info {
      flex: 1;
      min-width: 0;
    }
    
    .partner-info h4 {
      margin: 0 0 2px 0;
      font-size: 16px;
      font-weight: 600;
      color: #1f2937;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    
    .partner-info p {
      margin: 0;
      font-size: 13px;
      color: #10b981;
      font-weight: 500;
    }
    
    .voice-controls {
      display: flex;
      gap: 8px;
      flex-shrink: 0;
    }
    
    .voice-btn {
      background: #f3f4f6;
      border: 1px solid #e5e7eb;
      border-radius: 50%;
      width: 44px;
      height: 44px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 20px;
      transition: all 0.2s ease;
      -webkit-tap-highlight-color: transparent;
      color: #374151;
    }
    
    .voice-btn:hover {
      background: #e5e7eb;
      transform: scale(1.05);
    }
    
    .voice-btn.active {
      background: #10b981;
      color: white;
      border-color: #10b981;
    }
    
    .voice-btn.calling {
      background: #ef4444;
      border-color: #ef4444;
      color: white;
      animation: pulse 1.5s infinite;
    }
    
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.1); }
      100% { transform: scale(1); }
    }
    
    /* Chat Messages - WhatsApp Style */
    .chat-messages {
      flex: 1;
      overflow-y: auto;
      overflow-x: hidden;
      padding: 16px;
      background: #f0f2f5;
      display: flex;
      flex-direction: column;
      gap: 2px;
      min-height: 0;
      position: relative;
      scrollbar-width: thin;
      scrollbar-color: rgba(0, 0, 0, 0.2) transparent;
    }
    
    .chat-messages::-webkit-scrollbar {
      width: 6px;
    }
    
    .chat-messages::-webkit-scrollbar-track {
      background: transparent;
    }
    
    .chat-messages::-webkit-scrollbar-thumb {
      background-color: rgba(0, 0, 0, 0.2);
      border-radius: 3px;
    }
    
    .chat-messages::-webkit-scrollbar-thumb:hover {
      background-color: rgba(0, 0, 0, 0.3);
    }
    
    .message-group {
      display: flex;
      flex-direction: column;
      margin-bottom: 16px;
      flex-shrink: 0;
    }
    
    .message-group.own {
      align-items: flex-end;
    }
    
    .message-group.other {
      align-items: flex-start;
    }
    
    .message {
      max-width: 80%;
      word-wrap: break-word;
      position: relative;
      margin: 1px 0;
      transition: transform 0.2s ease;
      overflow: hidden;
    }
    
    /* Swipe-to-Reply Functionality */
    .message-container {
      position: relative;
      display: flex;
      align-items: center;
      width: 100%;
    }
    
    .message-swipe-area {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      z-index: 1;
      opacity: 0;
      transition: opacity 0.2s ease;
    }
    
    .message-swipe-area.left {
      left: 10px;
    }
    
    .message-swipe-area.right {
      right: 10px;
    }
    
    .reply-button, .react-button {
      background: #10b981;
      color: white;
      border: none;
      border-radius: 50%;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);
      transition: all 0.2s ease;
    }
    
    .reply-button:hover, .react-button:hover {
      background: #059669;
      transform: scale(1.1);
    }
    
    /* Message States */
    .message.swiping-left {
      transform: translateX(-50px);
    }
    
    .message.swiping-right {
      transform: translateX(50px);
    }
    
    .message.swiping-left .message-swipe-area.left,
    .message.swiping-right .message-swipe-area.right {
      opacity: 1;
    }
    
    .message.own {
      align-self: flex-end;
    }
    
    .message.other {
      align-self: flex-start;
    }
    
    .message-bubble {
      padding: 8px 12px;
      border-radius: 18px;
      position: relative;
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
    }
    
    .message.own .message-bubble {
      background: #dcf8c6;
      color: #1f2937;
    }
    
    .message.other .message-bubble {
      background: #ffffff;
      color: #1f2937;
    }
    
    .message-text {
      font-size: 14px;
      line-height: 1.4;
      margin: 0;
      font-weight: 400;
    }
    
    .message-time {
      font-size: 11px;
      opacity: 0.7;
      margin-top: 4px;
      text-align: right;
      color: #6b7280;
    }
    
    /* Reply Preview Styles */
    .reply-preview {
      background: #f0f9ff;
      border-left: 3px solid #10b981;
      padding: 8px 12px;
      margin-bottom: 8px;
      border-radius: 8px;
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 8px;
    }
    
    .reply-preview-content {
      flex: 1;
    }
    
    .reply-preview-header {
      font-size: 12px;
      font-weight: 600;
      color: #10b981;
      margin-bottom: 2px;
    }
    
    .reply-preview-text {
      font-size: 12px;
      color: #6b7280;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      max-width: 200px;
    }
    
    .reply-close-button {
      background: none;
      border: none;
      color: #9ca3af;
      cursor: pointer;
      padding: 2px;
      font-size: 16px;
      line-height: 1;
      flex-shrink: 0;
    }
    
    /* Message Replies */
    .message-reply {
      background: #f9fafb;
      border-left: 3px solid #10b981;
      padding: 6px 8px;
      margin-bottom: 6px;
      border-radius: 6px;
      font-size: 12px;
    }
    
    .message-reply-header {
      font-weight: 600;
      color: #10b981;
      margin-bottom: 2px;
    }
    
    .message-reply-text {
      color: #6b7280;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    
    /* Message Reactions */
    .message-reactions {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      margin-top: 4px;
      min-height: 0;
    }
    
    .reaction {
      background: rgba(255, 255, 255, 0.9);
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      padding: 2px 6px;
      display: flex;
      align-items: center;
      gap: 2px;
      font-size: 11px;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .reaction:hover {
      background: #f3f4f6;
      border-color: #10b981;
    }
    
    .reaction.own-reaction {
      background: #dcf8c6;
      border-color: #10b981;
    }
    
    .reaction-emoji {
      font-size: 12px;
    }
    
    .reaction-count {
      font-size: 10px;
      font-weight: 500;
      color: #6b7280;
      min-width: 8px;
    }
    
    /* Emoji Picker */
    .emoji-picker {
      position: absolute;
      background: white;
      border-radius: 20px;
      padding: 12px;
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
      z-index: 1000;
      display: none;
      max-width: 280px;
      border: 1px solid #e5e7eb;
    }
    
    .emoji-picker.show {
      display: block;
    }
    
    .emoji-picker-header {
      font-size: 12px;
      font-weight: 600;
      color: #6b7280;
      margin-bottom: 8px;
      text-align: center;
    }
    
    .emoji-picker-grid {
      display: grid;
      grid-template-columns: repeat(6, 1fr);
      gap: 8px;
    }
    
    .emoji-pick-button {
      background: none;
      border: none;
      font-size: 20px;
      padding: 8px;
      border-radius: 8px;
      cursor: pointer;
      transition: background-color 0.2s;
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .emoji-pick-button:hover {
      background: #f3f4f6;
    }
    
    /* Typing Indicator */
    .typing-indicator {
      padding: 12px 16px;
      font-style: italic;
      color: #6b7280;
      background: #f0f2f5;
      min-height: 36px;
      display: flex;
      align-items: center;
      font-size: 13px;
      flex-shrink: 0;
    }
    
    .typing-dots {
      display: inline-flex;
      align-items: center;
      gap: 2px;
      margin-left: 8px;
    }
    
    .typing-dot {
      width: 3px;
      height: 3px;
      border-radius: 50%;
      background: #6b7280;
      animation: typing-bounce 1.4s infinite ease-in-out;
    }
    
    .typing-dot:nth-child(2) { animation-delay: 0.2s; }
    .typing-dot:nth-child(3) { animation-delay: 0.4s; }
    
    @keyframes typing-bounce {
      0%, 60%, 100% { transform: translateY(0); }
      30% { transform: translateY(-4px); }
    }
    
    /* Input Area - WhatsApp Style */
    .input-area {
      display: flex;
      align-items: flex-end;
      padding: 12px;
      background: #ffffff;
      border-top: 1px solid #e5e7eb;
      gap: 8px;
      flex-shrink: 0;
      width: 100%;
      box-sizing: border-box;
      min-height: 56px;
    }
    
    .input-container {
      flex: 1;
      position: relative;
      display: flex;
      align-items: flex-end;
      background: #f3f4f6;
      border: 1px solid #e5e7eb;
      border-radius: 20px;
      padding: 6px 12px;
      transition: all 0.2s ease;
      max-height: 100px;
      min-width: 0;
      width: 100%;
      box-sizing: border-box;
    }
    
    .input-container:focus-within {
      border-color: #10b981;
      background: #ffffff;
    }
    
    .message-input {
      flex: 1;
      border: none;
      outline: none;
      font-size: 14px;
      background: transparent;
      resize: none;
      min-height: 18px;
      max-height: 80px;
      font-family: 'Inter', sans-serif;
      line-height: 1.3;
      font-weight: 400;
      color: #1f2937;
      padding: 6px 0;
      width: 100%;
      box-sizing: border-box;
      word-wrap: break-word;
      overflow-wrap: break-word;
      appearance: none;
      -webkit-appearance: none;
    }
    
    .message-input::placeholder {
      color: #9ca3af;
    }
    
    .emoji-button {
      background: none;
      border: none;
      font-size: 16px;
      cursor: pointer;
      padding: 2px;
      margin-right: 4px;
      border-radius: 50%;
      transition: background-color 0.2s;
      flex-shrink: 0;
      align-self: flex-end;
      margin-bottom: 2px;
      color: #6b7280;
      -webkit-tap-highlight-color: transparent;
      width: 24px;
      height: 24px;
    }
    
    .emoji-button:hover {
      background: #f3f4f6;
    }
    
    .send-button {
      background: #10b981;
      border: none;
      color: white;
      font-weight: 600;
      font-size: 14px;
      cursor: pointer;
      padding: 8px;
      border-radius: 50%;
      transition: all 0.2s ease;
      flex-shrink: 0;
      align-self: flex-end;
      font-family: 'Inter', sans-serif;
      width: 36px;
      height: 36px;
      min-width: 36px;
      min-height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
    }
    
    .send-button:hover {
      background: #059669;
      transform: scale(1.05);
    }
    
    .send-button:disabled {
      background: #d1d5db;
      cursor: not-allowed;
      transform: none;
    }
    
    /* Mobile Text Input Enhancements */
    @media (max-width: 768px) {
      .input-area {
        overflow: hidden;
      }
      
      .input-container {
        overflow: hidden;
      }
      
      .message-input {
        overflow-y: auto;
        overflow-x: hidden;
        white-space: pre-wrap;
        word-break: break-word;
      }
      
      /* Prevent zoom on focus for iOS */
      .message-input {
        font-size: max(16px, 1rem);
        -webkit-text-size-adjust: 100%;
        zoom: 1;
      }
    }
    
    /* Control Buttons - Hidden on Desktop, Integrated in Mobile */
    .chat-control-buttons {
      display: none;
    }
    
    .control-buttons {
      display: none;
    }
    
    .hidden { 
      display: none !important; 
    }
    
    /* Call Screen Styles - Modern Design */
    .call-screen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100vh;
      background: linear-gradient(135deg, #1f2937 0%, #111827 100%);
      z-index: 1000;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .call-container {
      text-align: center;
      color: white;
      max-width: 400px;
      width: 90%;
    }
    
    .call-header {
      margin-bottom: 48px;
    }
    
    .call-status {
      font-size: 16px;
      color: #9ca3af;
      margin-bottom: 8px;
      font-weight: 500;
    }
    
    .call-timer {
      font-size: 28px;
      font-weight: 600;
      color: white;
      font-family: 'Inter', sans-serif;
    }
    
    .call-avatar {
      margin-bottom: 48px;
    }
    
    .avatar-circle {
      width: 120px;
      height: 120px;
      border-radius: 50%;
      background: linear-gradient(45deg, #10b981 0%, #059669 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 20px;
      border: 4px solid rgba(255, 255, 255, 0.2);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    }
    
    .avatar-circle span {
      font-size: 48px;
      font-weight: 600;
      color: white;
    }
    
    .call-partner-name {
      font-size: 24px;
      font-weight: 600;
      margin-bottom: 8px;
      color: white;
    }
    
    .call-connection-status {
      font-size: 14px;
      color: #9ca3af;
      font-weight: 500;
    }
    
    .call-controls {
      display: flex;
      justify-content: center;
      gap: 24px;
    }
    
    .call-control-btn {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      border: none;
      font-size: 24px;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      -webkit-tap-highlight-color: transparent;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
    }
    
    .mute-btn {
      background: rgba(255, 255, 255, 0.2);
      color: white;
    }
    
    .mute-btn:hover {
      background: rgba(255, 255, 255, 0.3);
    }
    
    .mute-btn.muted {
      background: #ef4444;
    }
    
    .speaker-btn {
      background: rgba(255, 255, 255, 0.2);
      color: white;
    }
    
    .speaker-btn:hover {
      background: rgba(255, 255, 255, 0.3);
    }
    
    .speaker-btn.earpiece {
      background: #3b82f6;
    }
    
    .end-call-btn {
      background: #ef4444;
      color: white;
    }
    
    .end-call-btn:hover {
      background: #dc2626;
      transform: scale(1.05);
    }
    
    /* Incoming Call Styles - Modern Design */
    .incoming-call {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100vh;
      background: linear-gradient(135deg, #1e40af 0%, #1e3a8a 100%);
      z-index: 1001;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .incoming-call-container {
      text-align: center;
      color: white;
      max-width: 400px;
      width: 90%;
    }
    
    .incoming-call-header {
      margin-bottom: 48px;
    }
    
    .incoming-call-title {
      font-size: 18px;
      color: #dbeafe;
      margin-bottom: 16px;
      font-weight: 500;
    }
    
    .ringing-animation {
      font-size: 32px;
      animation: ring 1s infinite;
    }
    
    @keyframes ring {
      0%, 100% { transform: rotate(-10deg); }
      50% { transform: rotate(10deg); }
    }
    
    .incoming-call-avatar {
      margin-bottom: 48px;
    }
    
    .incoming-call-partner-name {
      font-size: 24px;
      font-weight: 600;
      margin-bottom: 8px;
      color: white;
    }
    
    .incoming-call-status {
      font-size: 14px;
      color: #dbeafe;
      font-weight: 500;
    }
    
    .incoming-call-controls {
      display: flex;
      justify-content: center;
      gap: 48px;
    }
    
    .incoming-call-btn {
      width: 72px;
      height: 72px;
      border-radius: 50%;
      border: none;
      font-size: 28px;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      -webkit-tap-highlight-color: transparent;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    }
    
    .decline-btn {
      background: #ef4444;
      color: white;
    }
    
    .decline-btn:hover {
      background: #dc2626;
      transform: scale(1.1);
    }
    
    .answer-btn {
      background: #22c55e;
      color: white;
    }
    
    .answer-btn:hover {
      background: #16a34a;
      transform: scale(1.1);
    }
    
    /* Mobile Responsiveness - WhatsApp Style */
    @media (max-width: 768px) {
      body {
        padding: 0;
        height: 100vh;
        height: -webkit-fill-available;
      }
      
      .main-container {
        align-items: stretch;
        padding: 0;
        height: 100vh;
        height: -webkit-fill-available;
      }
      
      .chat-container {
        width: 100vw;
        height: 100vh;
        height: -webkit-fill-available;
        max-height: 100vh;
        max-height: -webkit-fill-available;
        border-radius: 0;
        border: none;
        margin: 0;
        max-width: 100vw;
      }
      
      .profile-setup {
        padding: 20px;
        padding-top: 40px;
      }
      
      .waiting-screen {
        padding: 40px 20px 40px 20px;
      }
      
      .profile-setup h3 {
        font-size: 22px;
        margin-bottom: 24px;
      }
      
      .form-group input,
      .gender-btn,
      .start-btn {
        font-size: 16px;
        padding: 18px 16px;
      }
      
      .chat-header {
        padding: 12px 16px;
        min-height: 60px;
      }
      
      .partner-avatar {
        width: 36px;
        height: 36px;
        font-size: 15px;
      }
      
      .partner-info h4 {
        font-size: 15px;
      }
      
      .partner-info p {
        font-size: 12px;
      }
      
      .voice-btn {
        width: 40px;
        height: 40px;
        font-size: 18px;
      }
      
      .chat-messages {
        padding: 12px 16px;
      }
      
      .message-bubble {
        padding: 10px 14px;
      }
      
      .message-text {
        font-size: 15px;
        line-height: 1.4;
      }
      
      .input-area {
        padding: 12px 16px;
        gap: 8px;
      }
      
      .input-container {
        padding: 8px 14px;
      }
      
      .message-input {
        font-size: 15px;
        padding: 10px 0;
      }
      
      .send-button {
        width: 40px;
        height: 40px;
        font-size: 18px;
      }
      
      .emoji-button {
        font-size: 14px;
        padding: 2px;
        margin-right: 2px;
        width: 24px;
        height: 24px;
        flex-shrink: 0;
      }
      
      .typing-indicator {
        padding: 8px 16px;
        font-size: 12px;
      }
      
      .stats-panel {
        padding: 12px 16px;
        font-size: 12px;
      }
      
      /* Call Screen Mobile */
      .call-container {
        width: 95%;
        padding: 0 20px;
      }
      
      .avatar-circle {
        width: 100px;
        height: 100px;
      }
      
      .avatar-circle span {
        font-size: 40px;
      }
      
      .call-partner-name {
        font-size: 22px;
      }
      
      .call-timer {
        font-size: 24px;
      }
      
      .call-control-btn {
        width: 56px;
        height: 56px;
        font-size: 22px;
      }
      
      .call-controls {
        gap: 20px;
      }
      
      /* Incoming Call Mobile */
      .incoming-call-container {
        width: 95%;
        padding: 0 20px;
      }
      
      .incoming-call-btn {
        width: 64px;
        height: 64px;
        font-size: 24px;
      }
      
      .incoming-call-controls {
        gap: 40px;
      }
      
      .ringing-animation {
        font-size: 28px;
      }
      
      .incoming-call-partner-name {
        font-size: 22px;
      }
    }
    
    /* Samsung S24 and Similar High-End Android Devices */
    @media screen and (max-width: 428px) and (max-height: 926px) and (-webkit-min-device-pixel-ratio: 2.5) {
      html, body {
        height: 100vh;
        height: -webkit-fill-available;
        overflow: hidden;
      }
      
      .main-container {
        height: 100vh;
        height: -webkit-fill-available;
        padding: 0;
      }
      
      .chat-container {
        width: 100vw !important;
        height: 100vh !important;
        height: -webkit-fill-available !important;
        max-width: 100vw !important;
        max-height: 100vh !important;
        max-height: -webkit-fill-available !important;
        border-radius: 0 !important;
        border: none !important;
        margin: 0 !important;
      }
      
      .input-area {
        padding: 8px 12px;
        gap: 8px;
        position: relative;
        bottom: 0;
        background: #ffffff;
        border-top: 1px solid #e5e7eb;
        width: 100%;
        box-sizing: border-box;
        min-height: 52px;
      }
      
      .input-container {
        flex: 1;
        min-width: 0;
        max-width: calc(100% - 44px);
        padding: 4px 10px;
        border-radius: 18px;
      }
      
      .message-input {
        font-size: 16px;
        -webkit-text-size-adjust: 100%;
        padding: 4px 0;
      }
      
      .send-button {
        width: 32px;
        height: 32px;
        min-width: 32px;
        min-height: 32px;
        padding: 6px;
        font-size: 14px;
      }
      
      .chat-messages {
        padding: 12px 16px;
        padding-bottom: 8px;
      }
    }

    /* Small Mobile Devices */
    @media (max-width: 480px) {
      .chat-messages {
        padding: 8px 12px;
        padding-bottom: 4px;
      }
      
      .input-area {
        padding: 6px 10px;
        gap: 6px;
        position: relative;
        bottom: 0;
        width: 100%;
        box-sizing: border-box;
        min-height: 48px;
      }
      
      .input-container {
        flex: 1;
        min-width: 0;
        max-width: calc(100% - 36px);
        padding: 4px 8px;
        border-radius: 16px;
      }
      
      .message-input {
        font-size: 16px;
        padding: 4px 0;
      }
      
      .send-button {
        width: 28px;
        height: 28px;
        min-width: 28px;
        min-height: 28px;
        padding: 4px;
        font-size: 12px;
      }
      
      .chat-header {
        padding: 8px 12px;
      }
      
      .message {
        max-width: 85%;
      }
      
      .call-controls {
        gap: 16px;
      }
      
      .call-control-btn {
        width: 52px;
        height: 52px;
        font-size: 20px;
      }
      
      .incoming-call-controls {
        gap: 32px;
      }
      
      .incoming-call-btn {
        width: 60px;
        height: 60px;
        font-size: 22px;
      }
    }
    
    /* Call Screen Styles */
    .call-screen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100vh;
      background: linear-gradient(135deg, #1e1e1e 0%, #2d2d2d 100%);
      z-index: 1000;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .call-container {
      text-align: center;
      color: white;
      max-width: 400px;
      width: 90%;
    }
    
    .call-header {
      margin-bottom: 40px;
    }
    
    .call-status {
      font-size: 18px;
      color: #b0b0b0;
      margin-bottom: 10px;
    }
    
    .call-timer {
      font-size: 32px;
      font-weight: bold;
      color: white;
      font-family: 'Courier New', monospace;
    }
    
    .call-avatar {
      margin-bottom: 50px;
    }
    
    .avatar-circle {
      width: 150px;
      height: 150px;
      border-radius: 50%;
      background: #4a4a4a;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 20px;
      border: 4px solid #666;
    }
    
    .avatar-circle span {
      font-size: 60px;
      font-weight: bold;
      color: white;
    }
    
    .call-partner-name {
      font-size: 24px;
      font-weight: bold;
      margin-bottom: 8px;
    }
    
    .call-connection-status {
      font-size: 16px;
      color: #b0b0b0;
    }
    
    .call-controls {
      display: flex;
      justify-content: center;
      gap: 30px;
    }
    
    .call-control-btn {
      width: 70px;
      height: 70px;
      border-radius: 50%;
      border: none;
      font-size: 30px;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      -webkit-tap-highlight-color: transparent;
    }
    
    .mute-btn {
      background: #4a4a4a;
      color: white;
    }
    
    .mute-btn:hover {
      background: #5a5a5a;
    }
    
    .mute-btn.muted {
      background: #ff4444;
    }
    
    .speaker-btn {
      background: #4a4a4a;
      color: white;
    }
    
    .speaker-btn:hover {
      background: #5a5a5a;
    }
    
    .speaker-btn.earpiece {
      background: #2196F3;
    }
    
    .end-call-btn {
      background: #ff4444;
      color: white;
    }
    
    .end-call-btn:hover {
      background: #ff6666;
    }
    
    /* Responsive design */
    @media (max-width: 768px) {
      .chat-container {
        width: 100%;
        height: 100vh;
        border-radius: 0;
      }
      
      .call-container {
        width: 95%;
      }
      
      .avatar-circle {
        width: 120px;
        height: 120px;
      }
      
      .avatar-circle span {
        font-size: 48px;
      }
      
      .call-timer {
        font-size: 28px;
      }
      
      .call-control-btn {
        width: 60px;
        height: 60px;
        font-size: 24px;
      }
      
      /* Improve touch targets for mobile */
      .gender-btn {
        padding: 18px 12px;
        min-height: 60px;
      }
      
      .start-btn {
        padding: 20px 15px;
        min-height: 60px;
      }
      
      .voice-controls {
        gap: 12px;
      }
      
      .voice-btn {
        min-width: 56px;
        height: 48px;
        font-size: 20px;
        border-radius: 8px;
      }
      
      /* Improve input area for mobile */
      .input-area {
        padding: 15px;
        gap: 12px;
      }
      
      .message-input {
        min-height: 60px;
        padding: 15px;
        font-size: 16px;
      }
      
      .send-button, .emoji-button, .attach-button {
        min-width: 56px;
        min-height: 56px;
        padding: 16px;
      }
      
      /* Improve incoming call buttons for mobile */
      .incoming-call-controls {
        gap: 60px;
      }
      
      .incoming-call-btn {
        width: 90px;
        height: 90px;
        font-size: 40px;
      }
      
      /* Adjust main screen to account for floating buttons */
      .main-screen {
        min-height: auto;
      }
      
      /* Ensure stats panel has proper spacing */
      .stats-panel {
        padding: 12px 16px;
        font-size: 12px;
        display: block !important; /* Always show stats on mobile */
      }
      
      /* Make sure control buttons container is always visible when needed */
      .control-buttons:not(.hidden) {
        display: flex !important;
      }
    }
    
    /* Incoming Call Styles */
    .incoming-call {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100vh;
      background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
      z-index: 1001;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .incoming-call-container {
      text-align: center;
      color: white;
      max-width: 400px;
      width: 90%;
    }
    
    .incoming-call-header {
      margin-bottom: 40px;
    }
    
    .incoming-call-title {
      font-size: 20px;
      color: #ecf0f1;
      margin-bottom: 15px;
    }
    
    .ringing-animation {
      font-size: 40px;
      animation: ring 1s infinite;
    }
    
    @keyframes ring {
      0%, 100% { transform: rotate(-15deg); }
      50% { transform: rotate(15deg); }
    }
    
    .incoming-call-avatar {
      margin-bottom: 50px;
    }
    
    .incoming-call-partner-name {
      font-size: 26px;
      font-weight: bold;
      margin-bottom: 8px;
    }
    
    .incoming-call-status {
      font-size: 18px;
      color: #bdc3c7;
    }
    
    .incoming-call-controls {
      display: flex;
      justify-content: center;
      gap: 50px;
    }
    
    .incoming-call-btn {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      border: none;
      font-size: 35px;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      -webkit-tap-highlight-color: transparent;
    }
    
    .decline-btn {
      background: #e74c3c;
      color: white;
    }
    
    .decline-btn:hover {
      background: #c0392b;
      transform: scale(1.1);
    }
    
    .answer-btn {
      background: #27ae60;
      color: white;
    }
    
    .answer-btn:hover {
      background: #229954;
      transform: scale(1.1);
    }
  </style>
</head>
<body>
  <div class="main-container">
    <!-- Picture Section (70% width) -->
    <!-- Chat Container (30% width) -->
    <div class="chat-container">
    
    <!-- Profile Setup Screen -->
    <div class="profile-setup" id="profileSetup">
      <h3>Enter Details</h3>
      <div class="form-group">
        <label>Username:</label>
        <input id="usernameInput" placeholder="Enter your username..." maxlength="20" />
      </div>
      <div class="form-group">
        <label>Gender:</label>
        <div class="gender-buttons">
          <button class="gender-btn" data-gender="male" onclick="selectGender('male')">Guy</button>
          <button class="gender-btn" data-gender="female" onclick="selectGender('female')">Girl</button>
        </div>
      </div>
      <button class="start-btn" id="startBtn" onclick="setProfile()" disabled>Start Matching</button>
    </div>
    
    <!-- Stats Panel -->
    <div class="stats-panel hidden" id="statsPanel">
      <div class="stats-row">
        <span class="stats-label">Guys Online:</span>
        <span id="maleStats">Waiting: 0, Chatting: 0</span>
      </div>
      <div class="stats-row">
        <span class="stats-label">Girls Online:</span>
        <span id="femaleStats">Waiting: 0, Chatting: 0</span>
      </div>
    </div>
    
    <!-- Main Screen -->
    <div class="main-screen hidden" id="mainScreen">
      <!-- Waiting Screen -->
      <div class="waiting-screen hidden" id="waitingScreen">
        <div class="spinner"></div>
        <h3>Looking for a match...</h3>
        <p>Please wait while we find someone for you to chat with.</p>
      </div>
      
      <!-- Matched Screen -->
      <div class="matched-screen hidden" id="matchedScreen">
        <!-- Chat Header -->
        <div class="chat-header">
          <div class="partner-avatar" id="partnerAvatar">?</div>
          <div class="partner-info">
            <h4 id="partnerNameHeader">Partner</h4>
            <p id="partnerStatus">Online</p>
          </div>
          <div class="voice-controls">
            <button class="voice-btn" id="startCallBtn" onclick="startVoiceCall()" title="Start Voice Call">📞</button>
            <button class="voice-btn hidden" id="endCallBtn" onclick="endVoiceCall()" title="End Call">📞</button>
            <button class="voice-btn hidden" id="muteBtn" onclick="toggleMute()" title="Mute/Unmute">🔇</button>
          </div>
        </div>
        
        <div class="chat-messages" id="chatMessages"></div>
        
        <div class="typing-indicator" id="typingIndicator"></div>
        
        <div class="reply-preview" id="replyPreview" style="display: none;">
          <div class="reply-preview-content">
            <div class="reply-preview-header" id="replyPreviewHeader">Replying to</div>
            <div class="reply-preview-text" id="replyPreviewText"></div>
          </div>
          <button class="reply-close-button" onclick="cancelReply()">&times;</button>
        </div>
        
        <div class="input-area">
          <div class="input-container">
            <button class="emoji-button">😊</button>
            <textarea class="message-input" id="messageInput" placeholder="Type a message..." rows="1"></textarea>
          </div>
          <button class="send-button" id="sendBtn" onclick="sendMessage()">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
              <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
            </svg>
          </button>
        </div>
        
        <!-- Emoji Picker for Reactions -->
        <div class="emoji-picker" id="emojiPicker">
          <div class="emoji-picker-header">React with an emoji</div>
          <div class="emoji-picker-grid">
            <button class="emoji-pick-button" onclick="addReaction('❤️')">❤️</button>
            <button class="emoji-pick-button" onclick="addReaction('😂')">😂</button>
            <button class="emoji-pick-button" onclick="addReaction('😮')">😮</button>
            <button class="emoji-pick-button" onclick="addReaction('😢')">😢</button>
            <button class="emoji-pick-button" onclick="addReaction('😡')">😡</button>
            <button class="emoji-pick-button" onclick="addReaction('👍')">👍</button>
            <button class="emoji-pick-button" onclick="addReaction('👎')">👎</button>
            <button class="emoji-pick-button" onclick="addReaction('😍')">😍</button>
            <button class="emoji-pick-button" onclick="addReaction('🤔')">🤔</button>
            <button class="emoji-pick-button" onclick="addReaction('😊')">😊</button>
            <button class="emoji-pick-button" onclick="addReaction('🎉')">🎉</button>
            <button class="emoji-pick-button" onclick="addReaction('🔥')">🔥</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Call Screen Overlay -->
  <div class="call-screen hidden" id="callScreen">
    <div class="call-container">
      <div class="call-header">
        <div class="call-status">Voice Call</div>
        <div class="call-timer" id="callTimer">00:00</div>
      </div>
      
      <div class="call-avatar">
        <div class="avatar-circle" id="callAvatar">
          <span id="callPartnerInitial">?</span>
        </div>
        <div class="call-partner-name" id="callPartnerName">Partner</div>
        <div class="call-connection-status" id="callConnectionStatus">Connecting...</div>
      </div>
      
      <div class="call-controls">
        <button class="call-control-btn mute-btn" id="callMuteBtn" onclick="toggleMute()">
          <span id="muteIcon">🔇</span>
        </button>
        <button class="call-control-btn speaker-btn" id="speakerBtn" onclick="toggleSpeaker()">
          <span id="speakerIcon">🔊</span>
        </button>
        <button class="call-control-btn end-call-btn" onclick="endVoiceCall()">
          📞
        </button>
      </div>
    </div>
  </div>

  <!-- Incoming Call Overlay -->
  <div class="incoming-call hidden" id="incomingCall">
    <div class="incoming-call-container">
      <div class="incoming-call-header">
        <div class="incoming-call-title">Incoming Voice Call</div>
        <div class="ringing-animation">📞</div>
      </div>
      
      <div class="incoming-call-avatar">
        <div class="avatar-circle" id="incomingCallAvatar">
          <span id="incomingCallPartnerInitial">?</span>
        </div>
        <div class="incoming-call-partner-name" id="incomingCallPartnerName">Partner</div>
        <div class="incoming-call-status">is calling you...</div>
      </div>
      
      <div class="incoming-call-controls">
        <button class="incoming-call-btn decline-btn" onclick="declineCall()">
          ❌
        </button>
        <button class="incoming-call-btn answer-btn" onclick="answerCall()">
          📞
        </button>
      </div>
    </div>
  </div>

  <script>
    let ws = null;
    let myId = null;
    let myUsername = null;
    let myGender = null;
    let currentState = 'profile'; // profile, online, waiting, matched
    let soundEnabled = true;
    let reconnectInterval = null;
    let typingTimeout;
    let partnerInfo = null;
    let messageGroups = [];
    let lastMessageSender = null;

    // Voice chat variables
    let localStream = null;
    let peerConnection = null;
    let isCallActive = false;
    let isMuted = false;
    let isSpeakerOn = true; // Speaker is on by default
    
    // Call screen variables
    let callStartTime = null;
    let callTimerInterval = null;
    let isIncomingCall = false;
    let callState = 'idle'; // idle, calling, ringing, connected

    const elements = {
      profileSetup: document.getElementById('profileSetup'),
      usernameInput: document.getElementById('usernameInput'),
      startBtn: document.getElementById('startBtn'),
      statsPanel: document.getElementById('statsPanel'),
      maleStats: document.getElementById('maleStats'),
      femaleStats: document.getElementById('femaleStats'),
      mainScreen: document.getElementById('mainScreen'),
      waitingScreen: document.getElementById('waitingScreen'),
      matchedScreen: document.getElementById('matchedScreen'),
      chatMessages: document.getElementById('chatMessages'),
      messageInput: document.getElementById('messageInput'),
      typingIndicator: document.getElementById('typingIndicator'),
      partnerNameHeader: document.getElementById('partnerNameHeader'),
      partnerAvatar: document.getElementById('partnerAvatar'),
      partnerStatus: document.getElementById('partnerStatus'),
      sendBtn: document.getElementById('sendBtn'),
      startCallBtn: document.getElementById('startCallBtn'),
      endCallBtn: document.getElementById('endCallBtn'),
      muteBtn: document.getElementById('muteBtn'),
      callScreen: document.getElementById('callScreen'),
      callTimer: document.getElementById('callTimer'),
      callAvatar: document.getElementById('callAvatar'),
      callPartnerName: document.getElementById('callPartnerName'),
      callPartnerInitial: document.getElementById('callPartnerInitial'),
      callConnectionStatus: document.getElementById('callConnectionStatus'),
      callMuteBtn: document.getElementById('callMuteBtn'),
      muteIcon: document.getElementById('muteIcon'),
      speakerBtn: document.getElementById('speakerBtn'),
      speakerIcon: document.getElementById('speakerIcon'),
      incomingCall: document.getElementById('incomingCall'),
      incomingCallAvatar: document.getElementById('incomingCallAvatar'),
      incomingCallPartnerName: document.getElementById('incomingCallPartnerName'),
      incomingCallPartnerInitial: document.getElementById('incomingCallPartnerInitial')
    };

    function connect() {
      ws = new WebSocket('wss://chat-backend-4tpa.onrender.com');
      
      ws.onopen = () => {
        if (reconnectInterval) {
          clearInterval(reconnectInterval);
          reconnectInterval = null;
        }
      };

      ws.onclose = () => {
        if (!reconnectInterval) {
          reconnectInterval = setInterval(connect, 3000);
        }
      };

      ws.onerror = () => {
        // Connection error handling
      };

      ws.onmessage = handleMessage;
    }

    function handleMessage(event) {
      let data;
      try { data = JSON.parse(event.data); } catch { return; }
      
      switch(data.type) {
        case 'welcome':
          myId = data.id;
          if (data.stats) {
            updateStats(data.stats);
          }
          break;
          
        case 'statsUpdate':
          updateStats(data.stats);
          break;
          
        case 'waiting':
          currentState = 'waiting';
          showWaitingScreen();
          break;
          
        case 'matched':
          currentState = 'matched';
          partnerInfo = data.partner;
          elements.partnerNameHeader.textContent = data.partner.username;
          elements.partnerAvatar.textContent = data.partner.username[0].toUpperCase();
          elements.partnerStatus.textContent = 'Online';
          showMatchedScreen();
          if (soundEnabled) playNotification();
          break;
          
        case 'message':
          displayMessage(data);
          if (!data.fromMe && soundEnabled) playNotification();
          break;
          
        case 'reaction':
          handleReactionUpdate(data);
          break;
          
        case 'typing':
          if (data.typing) {
            elements.typingIndicator.innerHTML = `
              ${partnerInfo?.username || 'Partner'} is typing
              <span class="typing-dots">
                <span class="typing-dot"></span>
                <span class="typing-dot"></span>
                <span class="typing-dot"></span>
              </span>
            `;
          } else {
            elements.typingIndicator.textContent = '';
          }
          break;
          
        case 'voiceSignal':
          handleVoiceSignal(data);
          break;
          
        case 'partnerDisconnected':
          currentState = 'online';
          endVoiceCall(); // End any active call when partner disconnects
          showDisconnectedMessage(data.message);
          showOnlineScreen();
          break;
      }
    }

    function selectGender(gender) {
      myGender = gender;
      document.querySelectorAll('.gender-btn').forEach(btn => {
        btn.classList.remove('selected');
      });
      document.querySelector(`[data-gender="${gender}"]`).classList.add('selected');
      checkFormValid();
    }

    function checkFormValid() {
      const username = elements.usernameInput.value.trim();
      elements.startBtn.disabled = !username || !myGender;
    }

    function setProfile() {
      const username = elements.usernameInput.value.trim();
      if (!username || !myGender) return;
      
      myUsername = username;
      ws.send(JSON.stringify({ 
        type: 'setProfile', 
        username: myUsername,
        gender: myGender
      }));
      
      currentState = 'online';
      showOnlineScreen();
      
      // Automatically start matching after profile is set
      setTimeout(() => {
        findMatch();
      }, 500);
    }

    function showOnlineScreen() {
      elements.profileSetup.classList.add('hidden');
      elements.statsPanel.classList.remove('hidden');
      elements.mainScreen.classList.remove('hidden');
      elements.waitingScreen.classList.add('hidden');
      elements.matchedScreen.classList.add('hidden');
    }

    function showWaitingScreen() {
      elements.waitingScreen.classList.remove('hidden');
      elements.matchedScreen.classList.add('hidden');
    }

    function showMatchedScreen() {
      elements.waitingScreen.classList.add('hidden');
      elements.matchedScreen.classList.remove('hidden');
      // Keep stats visible on mobile for better UX
      elements.chatMessages.innerHTML = '';
      messageGroups = [];
      lastMessageSender = null;
      
      // Auto-resize textarea
      autoResizeTextarea();
      setTimeout(() => elements.messageInput.focus(), 100);
    }

    function autoResizeTextarea() {
      const textarea = elements.messageInput;
      textarea.addEventListener('input', function() {
        // Reset height to calculate new height
        this.style.height = '20px';
        // Set new height with max limit
        this.style.height = Math.min(this.scrollHeight, 80) + 'px';
        
        // Update send button state
        elements.sendBtn.disabled = !this.value.trim();
        elements.sendBtn.style.color = this.value.trim() ? '#222222' : '#cccccc';
      });
      
      // Initial state
      elements.sendBtn.disabled = true;
      elements.sendBtn.style.color = '#cccccc';
    }

    function findMatch() {
      if (!ws || ws.readyState !== WebSocket.OPEN) return;
      ws.send(JSON.stringify({ type: 'findMatch' }));
    }

    function disconnect() {
      if (!ws || ws.readyState !== WebSocket.OPEN) return;
      ws.send(JSON.stringify({ type: 'disconnect' }));
      currentState = 'online';
      showOnlineScreen();
    }

    function findNewMatch() {
      disconnect();
      setTimeout(() => findMatch(), 500);
    }

    // Reply functionality
    let replyingTo = null;

    function cancelReply() {
      replyingTo = null;
      document.getElementById('replyPreview').style.display = 'none';
    }

    function setReply(messageData) {
      replyingTo = messageData;
      const replyPreview = document.getElementById('replyPreview');
      const replyHeader = document.getElementById('replyPreviewHeader');
      const replyText = document.getElementById('replyPreviewText');
      
      replyHeader.textContent = messageData.fromMe ? 'Replying to yourself' : 'Replying to partner';
      replyText.textContent = messageData.text;
      replyPreview.style.display = 'flex';
      
      // Focus input
      elements.messageInput.focus();
    }

    // Emoji reactions functionality
    let currentReactionMessage = null;

    function showEmojiPicker(messageElement, messageData) {
      currentReactionMessage = { element: messageElement, data: messageData };
      const picker = document.getElementById('emojiPicker');
      const rect = messageElement.getBoundingClientRect();
      
      picker.style.display = 'block';
      picker.style.position = 'fixed';
      picker.style.top = `${Math.max(10, rect.top - picker.offsetHeight - 10)}px`;
      picker.style.left = `${Math.min(window.innerWidth - 290, Math.max(10, rect.left))}px`;
      
      // Close picker when clicking outside
      document.addEventListener('click', closeEmojiPickerOnOutsideClick);
    }

    function closeEmojiPickerOnOutsideClick(event) {
      const picker = document.getElementById('emojiPicker');
      if (!picker.contains(event.target)) {
        picker.style.display = 'none';
        document.removeEventListener('click', closeEmojiPickerOnOutsideClick);
        currentReactionMessage = null;
      }
    }

    function addReaction(emoji) {
      if (!currentReactionMessage || !ws || ws.readyState !== WebSocket.OPEN) return;
      
      // Send reaction to server
      ws.send(JSON.stringify({
        type: 'reaction',
        messageId: currentReactionMessage.data.id,
        emoji: emoji
      }));
      
      // Hide picker
      document.getElementById('emojiPicker').style.display = 'none';
      currentReactionMessage = null;
      document.removeEventListener('click', closeEmojiPickerOnOutsideClick);
    }

    // Touch gesture handling for swipe-to-reply
    function initializeSwipeGestures() {
      let startX = 0;
      let startY = 0;
      let currentMessage = null;
      let isSwipeActive = false;

      document.getElementById('chatMessages').addEventListener('touchstart', function(e) {
        const messageElement = e.target.closest('.message');
        if (!messageElement) return;
        
        startX = e.touches[0].clientX;
        startY = e.touches[0].clientY;
        currentMessage = messageElement;
        isSwipeActive = false;
      });

      document.getElementById('chatMessages').addEventListener('touchmove', function(e) {
        if (!currentMessage) return;
        
        const deltaX = e.touches[0].clientX - startX;
        const deltaY = e.touches[0].clientY - startY;
        
        // Only handle horizontal swipes
        if (Math.abs(deltaY) > Math.abs(deltaX)) {
          return;
        }
        
        e.preventDefault();
        
        if (Math.abs(deltaX) > 20) {
          isSwipeActive = true;
          
          if (deltaX > 0 && deltaX < 80) {
            // Swipe right (reveal reply on left side)
            currentMessage.style.transform = `translateX(${Math.min(deltaX, 60)}px)`;
            currentMessage.classList.add('swiping-right');
            currentMessage.classList.remove('swiping-left');
          } else if (deltaX < 0 && deltaX > -80) {
            // Swipe left (reveal react on right side)
            currentMessage.style.transform = `translateX(${Math.max(deltaX, -60)}px)`;
            currentMessage.classList.add('swiping-left');
            currentMessage.classList.remove('swiping-right');
          }
        }
      });

      document.getElementById('chatMessages').addEventListener('touchend', function(e) {
        if (!currentMessage) return;
        
        const deltaX = e.changedTouches[0].clientX - startX;
        
        if (isSwipeActive && Math.abs(deltaX) > 40) {
          if (deltaX > 0) {
            // Swipe right - reply
            const messageData = JSON.parse(currentMessage.dataset.messageData || '{}');
            setReply(messageData);
          } else {
            // Swipe left - react
            const messageData = JSON.parse(currentMessage.dataset.messageData || '{}');
            showEmojiPicker(currentMessage, messageData);
          }
        }
        
        // Reset message position
        currentMessage.style.transform = '';
        currentMessage.classList.remove('swiping-left', 'swiping-right');
        currentMessage = null;
        isSwipeActive = false;
      });
    }

    function sendMessage() {
      const text = elements.messageInput.value.trim();
      if (!text || !ws || ws.readyState !== WebSocket.OPEN || currentState !== 'matched') return;
      
      const messageData = {
        type: 'message',
        text: text
      };
      
      // Add reply data if replying
      if (replyingTo) {
        messageData.replyTo = replyingTo;
        cancelReply(); // Clear reply after sending
      }
      
      ws.send(JSON.stringify(messageData));
      elements.messageInput.value = '';
      elements.messageInput.style.height = '20px';
      elements.sendBtn.disabled = true;
      elements.sendBtn.style.color = '#cccccc';
      sendTyping(false);
    }

    function sendTyping(isTyping) {
      if (!ws || ws.readyState !== WebSocket.OPEN || currentState !== 'matched') return;
      ws.send(JSON.stringify({ type: 'typing', typing: isTyping }));
    }

    function displayMessage(data) {
      const isOwn = data.fromMe;
      const senderChanged = lastMessageSender !== (isOwn ? 'me' : 'partner');
      
      // Create message group if sender changed or if it's been more than 5 minutes
      if (senderChanged) {
        createNewMessageGroup(isOwn);
        lastMessageSender = isOwn ? 'me' : 'partner';
      }
      
      // Add message to current group
      const messageDiv = document.createElement('div');
      messageDiv.className = `message ${isOwn ? 'own' : 'other'}`;
      
      // Generate unique message ID if not provided
      if (!data.id) {
        data.id = 'msg_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
      }
      
      // Store message data for gestures
      messageDiv.dataset.messageData = JSON.stringify(data);
      
      let messageHTML = '<div class="message-container">';
      
      // Add swipe areas
      messageHTML += `
        <div class="message-swipe-area left">
          <button class="reply-button" onclick="setReply(${escapeHtml(JSON.stringify(data))})">↩</button>
        </div>
        <div class="message-swipe-area right">
          <button class="react-button" onclick="showEmojiPicker(this.closest('.message'), ${escapeHtml(JSON.stringify(data))})">😊</button>
        </div>
      `;
      
      messageHTML += '<div class="message-bubble">';
      
      // Add reply reference if this is a reply
      if (data.replyTo) {
        messageHTML += `
          <div class="message-reply">
            <div class="message-reply-header">${data.replyTo.fromMe ? 'You' : 'Partner'}</div>
            <div class="message-reply-text">${escapeHtml(data.replyTo.text)}</div>
          </div>
        `;
      }
      
      messageHTML += `<div class="message-text">${escapeHtml(data.text)}</div>`;
      
      // Add reactions if any
      if (data.reactions && data.reactions.length > 0) {
        messageHTML += '<div class="message-reactions">';
        const reactionCounts = {};
        
        data.reactions.forEach(reaction => {
          reactionCounts[reaction.emoji] = reactionCounts[reaction.emoji] || { count: 0, hasOwn: false };
          reactionCounts[reaction.emoji].count++;
          if (reaction.fromMe) {
            reactionCounts[reaction.emoji].hasOwn = true;
          }
        });
        
        Object.entries(reactionCounts).forEach(([emoji, info]) => {
          messageHTML += `
            <div class="reaction ${info.hasOwn ? 'own-reaction' : ''}" onclick="addReaction('${emoji}')">
              <span class="reaction-emoji">${emoji}</span>
              <span class="reaction-count">${info.count}</span>
            </div>
          `;
        });
        
        messageHTML += '</div>';
      }
      
      messageHTML += '</div></div>'; // Close message-bubble and message-container
      
      messageDiv.innerHTML = messageHTML;
      
      // Add to current message group
      const currentGroup = elements.chatMessages.lastElementChild;
      currentGroup.appendChild(messageDiv);
      
      elements.chatMessages.scrollTop = elements.chatMessages.scrollHeight;
    }

    function createNewMessageGroup(isOwn) {
      const groupDiv = document.createElement('div');
      groupDiv.className = `message-group ${isOwn ? 'own' : 'other'}`;
      elements.chatMessages.appendChild(groupDiv);
    }

    function handleReactionUpdate(data) {
      // Find the message element by ID
      const messageElements = document.querySelectorAll('.message');
      for (let messageElement of messageElements) {
        const messageData = JSON.parse(messageElement.dataset.messageData || '{}');
        if (messageData.id === data.messageId) {
          // Update the message data with new reactions
          messageData.reactions = data.reactions;
          messageElement.dataset.messageData = JSON.stringify(messageData);
          
          // Find and update the reactions display
          const messageBubble = messageElement.querySelector('.message-bubble');
          let reactionsContainer = messageBubble.querySelector('.message-reactions');
          
          if (data.reactions && data.reactions.length > 0) {
            // Create or update reactions container
            if (!reactionsContainer) {
              reactionsContainer = document.createElement('div');
              reactionsContainer.className = 'message-reactions';
              messageBubble.appendChild(reactionsContainer);
            }
            
            // Rebuild reactions display
            const reactionCounts = {};
            data.reactions.forEach(reaction => {
              reactionCounts[reaction.emoji] = reactionCounts[reaction.emoji] || { count: 0, hasOwn: false };
              reactionCounts[reaction.emoji].count++;
              if (reaction.fromMe) {
                reactionCounts[reaction.emoji].hasOwn = true;
              }
            });
            
            let reactionsHTML = '';
            Object.entries(reactionCounts).forEach(([emoji, info]) => {
              reactionsHTML += `
                <div class="reaction ${info.hasOwn ? 'own-reaction' : ''}" onclick="addReaction('${emoji}')">
                  <span class="reaction-emoji">${emoji}</span>
                  <span class="reaction-count">${info.count}</span>
                </div>
              `;
            });
            
            reactionsContainer.innerHTML = reactionsHTML;
          } else if (reactionsContainer) {
            // Remove reactions container if no reactions
            reactionsContainer.remove();
          }
          
          break;
        }
      }
    }

    function showDisconnectedMessage(message) {
      const messageDiv = document.createElement('div');
      messageDiv.className = 'message';
      messageDiv.style.background = '#ffebee';
      messageDiv.style.color = '#c62828';
      messageDiv.style.textAlign = 'center';
      messageDiv.style.maxWidth = '100%';
      messageDiv.innerHTML = `<div class="message-text">${message}</div>`;
      elements.chatMessages.appendChild(messageDiv);
      elements.chatMessages.scrollTop = elements.chatMessages.scrollHeight;
    }

    function addSystemMessage(message) {
      const messageDiv = document.createElement('div');
      messageDiv.className = 'message';
      messageDiv.style.background = '#f0f0f0';
      messageDiv.style.color = '#666';
      messageDiv.style.textAlign = 'center';
      messageDiv.style.maxWidth = '100%';
      messageDiv.style.fontSize = '14px';
      messageDiv.style.padding = '8px 12px';
      messageDiv.style.margin = '5px auto';
      messageDiv.innerHTML = `<div class="message-text">${message}</div>`;
      elements.chatMessages.appendChild(messageDiv);
      elements.chatMessages.scrollTop = elements.chatMessages.scrollHeight;
    }

    function updateStats(stats) {
      elements.maleStats.textContent = `Waiting: ${stats.waiting.male}, Chatting: ${stats.matched.male}`;
      elements.femaleStats.textContent = `Waiting: ${stats.waiting.female}, Chatting: ${stats.matched.female}`;
    }

    function playNotification() {
      const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmLjAzuByvHZiDcIGmi67eeeTRAMUKfj8LZjHAY4kdfyz3QdB');
      audio.volume = 0.3;
      audio.play().catch(() => {});
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Voice Chat Functions
    async function startVoiceCall() {
      if (ws && ws.readyState === WebSocket.OPEN) {
        callState = 'calling';
        ws.send(JSON.stringify({
          type: 'voiceSignal',
          signalType: 'call-request'
        }));
        
        addSystemMessage('📞 Calling...');
        
        // Show calling state on start call button
        elements.startCallBtn.textContent = '⏳';
        elements.startCallBtn.disabled = true;
      }
    }
    
    function showIncomingCall() {
      if (partnerInfo) {
        elements.incomingCallPartnerName.textContent = partnerInfo.username;
        elements.incomingCallPartnerInitial.textContent = partnerInfo.username.charAt(0).toUpperCase();
      }
      
      isIncomingCall = true;
      callState = 'ringing';
      elements.incomingCall.classList.remove('hidden');
    }
    
    function hideIncomingCall() {
      isIncomingCall = false;
      elements.incomingCall.classList.add('hidden');
    }
    
    async function answerCall() {
      try {
        hideIncomingCall();
        
        // Request microphone permission
        localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
        
        // Create peer connection
        peerConnection = new RTCPeerConnection({
          iceServers: [{ urls: 'stun:stun.l.google.com:19302' }]
        });
        
        // Add local stream to peer connection
        localStream.getTracks().forEach(track => {
          peerConnection.addTrack(track, localStream);
        });
        
        // Handle incoming audio stream
        peerConnection.ontrack = (event) => {
          const remoteAudio = new Audio();
          remoteAudio.srcObject = event.streams[0];
          setSpeakerMode(remoteAudio, isSpeakerOn);
          remoteAudio.play();
        };
        
        // Handle ICE candidates
        peerConnection.onicecandidate = (event) => {
          if (event.candidate && ws && ws.readyState === WebSocket.OPEN) {
            ws.send(JSON.stringify({
              type: 'voiceSignal',
              signalType: 'ice-candidate',
              candidate: event.candidate
            }));
          }
        };
        
        // Send acceptance and wait for offer
        if (ws && ws.readyState === WebSocket.OPEN) {
          ws.send(JSON.stringify({
            type: 'voiceSignal',
            signalType: 'call-accepted'
          }));
        }
        
        callState = 'connected';
        
      } catch (error) {
        console.error('Error answering call:', error);
        alert('Could not access microphone. Please check permissions.');
        declineCall();
      }
    }
    
    function declineCall() {
      hideIncomingCall();
      
      if (ws && ws.readyState === WebSocket.OPEN) {
        ws.send(JSON.stringify({
          type: 'voiceSignal',
          signalType: 'call-declined'
        }));
      }
      
      callState = 'idle';
      addSystemMessage('📞 Call declined');
    }
    
    async function initiateActualCall() {
      try {
        // Request microphone permission for caller
        localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
        
        // Create peer connection
        peerConnection = new RTCPeerConnection({
          iceServers: [{ urls: 'stun:stun.l.google.com:19302' }]
        });
        
        // Add local stream to peer connection
        localStream.getTracks().forEach(track => {
          peerConnection.addTrack(track, localStream);
        });
        
        // Handle incoming audio stream
        peerConnection.ontrack = (event) => {
          const remoteAudio = new Audio();
          remoteAudio.srcObject = event.streams[0];
          setSpeakerMode(remoteAudio, isSpeakerOn);
          remoteAudio.play();
        };
        
        // Handle ICE candidates
        peerConnection.onicecandidate = (event) => {
          if (event.candidate && ws && ws.readyState === WebSocket.OPEN) {
            ws.send(JSON.stringify({
              type: 'voiceSignal',
              signalType: 'ice-candidate',
              candidate: event.candidate
            }));
          }
        };
        
        // Create and send offer
        const offer = await peerConnection.createOffer();
        await peerConnection.setLocalDescription(offer);
        
        if (ws && ws.readyState === WebSocket.OPEN) {
          ws.send(JSON.stringify({
            type: 'voiceSignal',
            signalType: 'offer',
            offer: offer
          }));
        }
        
        isCallActive = true;
        updateVoiceUI();
        showCallScreen();
        updateCallConnectionStatus('Connecting...');
        
      } catch (error) {
        console.error('Error initiating call:', error);
        alert('Could not access microphone. Please check permissions.');
      }
    }
    
    function endVoiceCall() {
      if (localStream) {
        localStream.getTracks().forEach(track => track.stop());
        localStream = null;
      }
      
      if (peerConnection) {
        peerConnection.close();
        peerConnection = null;
      }
      
      if (ws && ws.readyState === WebSocket.OPEN) {
        ws.send(JSON.stringify({
          type: 'voiceSignal',
          signalType: 'end-call'
        }));
      }
      
      isCallActive = false;
      isMuted = false;
      callState = 'idle';
      hideIncomingCall();
      updateVoiceUI();
      hideCallScreen();
      
      // Reset call button
      elements.startCallBtn.textContent = '📞';
      elements.startCallBtn.disabled = false;
      
      // Add call ended message to chat if call was active
      if (callStartTime) {
        const callDuration = Math.floor((Date.now() - callStartTime) / 1000);
        const minutes = Math.floor(callDuration / 60);
        const seconds = callDuration % 60;
        
        let durationText;
        if (minutes > 0) {
          durationText = `${minutes} minute${minutes !== 1 ? 's' : ''}`;
          if (seconds > 0) {
            durationText += ` and ${seconds} second${seconds !== 1 ? 's' : ''}`;
          }
        } else {
          durationText = `${seconds} second${seconds !== 1 ? 's' : ''}`;
        }
        
        addSystemMessage(`📞 Call ended. Duration: ${durationText}`);
      }
    }
    
    function toggleMute() {
      if (localStream) {
        localStream.getAudioTracks().forEach(track => {
          track.enabled = !track.enabled;
        });
        isMuted = !isMuted;
        updateVoiceUI();
        updateCallScreenMute();
      }
    }
    
    function toggleSpeaker() {
      isSpeakerOn = !isSpeakerOn;
      updateCallScreenSpeaker();
      
      // Apply speaker mode to any active remote audio
      const remoteAudios = document.querySelectorAll('audio');
      remoteAudios.forEach(audio => {
        if (audio.srcObject) {
          setSpeakerMode(audio, isSpeakerOn);
        }
      });
    }
    
    function setSpeakerMode(audioElement, useSpeaker) {
      if (audioElement.setSinkId && typeof audioElement.setSinkId === 'function') {
        // Use setSinkId if available (Chrome, Edge)
        if (useSpeaker) {
          audioElement.setSinkId('default').catch(err => {
            console.log('Could not set speaker output:', err);
          });
        } else {
          // Try to use earpiece/phone speaker (device-dependent)
          navigator.mediaDevices.enumerateDevices().then(devices => {
            const audioOutputs = devices.filter(device => device.kind === 'audiooutput');
            const earpiece = audioOutputs.find(device => 
              device.label.toLowerCase().includes('earpiece') || 
              device.label.toLowerCase().includes('phone') ||
              device.label.toLowerCase().includes('receiver')
            );
            if (earpiece) {
              audioElement.setSinkId(earpiece.deviceId).catch(err => {
                console.log('Could not set earpiece output:', err);
              });
            }
          }).catch(err => {
            console.log('Could not enumerate devices:', err);
          });
        }
      }
    }
    
    function updateVoiceUI() {
      if (isCallActive) {
        elements.startCallBtn.classList.add('hidden');
        elements.endCallBtn.classList.remove('hidden');
        elements.muteBtn.classList.remove('hidden');
        elements.startCallBtn.classList.remove('calling');
        
        if (isMuted) {
          elements.muteBtn.textContent = '🔇';
          elements.muteBtn.classList.add('active');
        } else {
          elements.muteBtn.textContent = '🎤';
          elements.muteBtn.classList.remove('active');
        }
      } else {
        elements.startCallBtn.classList.remove('hidden');
        elements.endCallBtn.classList.add('hidden');
        elements.muteBtn.classList.add('hidden');
        elements.startCallBtn.classList.remove('calling');
      }
    }
    
    async function handleVoiceSignal(data) {
      try {
        if (data.signalType === 'call-request') {
          // Incoming call request - show ringing UI
          showIncomingCall();
          const callerName = partnerInfo ? partnerInfo.username : 'Partner';
          addSystemMessage(`📞 Incoming call from ${callerName}`);
          
        } else if (data.signalType === 'call-accepted') {
          // Call was accepted, start the actual WebRTC flow
          initiateActualCall();
          addSystemMessage('📞 Call accepted - connecting...');
          
        } else if (data.signalType === 'call-declined') {
          // Call was declined
          callState = 'idle';
          elements.startCallBtn.textContent = '📞';
          elements.startCallBtn.disabled = false;
          addSystemMessage('📞 Call declined');
          
        } else if (data.signalType === 'offer') {
          // WebRTC offer - for call receiver
          await peerConnection.setRemoteDescription(data.offer);
          const answer = await peerConnection.createAnswer();
          await peerConnection.setLocalDescription(answer);
          
          ws.send(JSON.stringify({
            type: 'voiceSignal',
            signalType: 'answer',
            answer: answer
          }));
          
          isCallActive = true;
          updateVoiceUI();
          showCallScreen();
          updateCallConnectionStatus('Connected');
          startCallTimer();
          addSystemMessage('📞 Voice chat connected');
          
        } else if (data.signalType === 'answer') {
          // WebRTC answer - for call initiator
          await peerConnection.setRemoteDescription(data.answer);
          updateCallConnectionStatus('Connected');
          startCallTimer();
          addSystemMessage('📞 Voice chat connected');
          
        } else if (data.signalType === 'ice-candidate') {
          if (peerConnection) {
            await peerConnection.addIceCandidate(data.candidate);
          }
          
        } else if (data.signalType === 'end-call') {
          endVoiceCall();
        }
      } catch (error) {
        console.error('Error handling voice signal:', error);
      }
    }

    // Call Screen Functions
    function showCallScreen() {
      if (partnerInfo) {
        // Update call screen with partner info
        elements.callPartnerName.textContent = partnerInfo.username;
        elements.callPartnerInitial.textContent = partnerInfo.username.charAt(0).toUpperCase();
      }
      
      elements.callScreen.classList.remove('hidden');
      elements.callConnectionStatus.textContent = 'Connecting...';
      updateCallScreenSpeaker(); // Initialize speaker button state
    }
    
    function startCallTimer() {
      // Start call timer only when call is connected
      callStartTime = Date.now();
      callTimerInterval = setInterval(updateCallTimer, 1000);
    }
    
    function hideCallScreen() {
      elements.callScreen.classList.add('hidden');
      
      // Stop call timer
      if (callTimerInterval) {
        clearInterval(callTimerInterval);
        callTimerInterval = null;
      }
      callStartTime = null;
      elements.callTimer.textContent = '00:00';
    }
    
    function updateCallTimer() {
      if (callStartTime) {
        const elapsed = Math.floor((Date.now() - callStartTime) / 1000);
        const minutes = Math.floor(elapsed / 60);
        const seconds = elapsed % 60;
        elements.callTimer.textContent = 
          `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
      }
    }
    
    function updateCallConnectionStatus(status) {
      elements.callConnectionStatus.textContent = status;
    }
    
    function updateCallScreenMute() {
      if (isMuted) {
        elements.muteIcon.textContent = '🔇';
        elements.callMuteBtn.classList.add('muted');
      } else {
        elements.muteIcon.textContent = '🎤';
        elements.callMuteBtn.classList.remove('muted');
      }
    }
    
    function updateCallScreenSpeaker() {
      if (isSpeakerOn) {
        elements.speakerIcon.textContent = '🔊';
        elements.speakerBtn.classList.remove('earpiece');
        elements.speakerBtn.title = 'Switch to Earpiece';
      } else {
        elements.speakerIcon.textContent = '🔉';
        elements.speakerBtn.classList.add('earpiece');
        elements.speakerBtn.title = 'Switch to Speaker';
      }
    }

    function formatTime(timestamp) {
      if (!timestamp) return '';
      const date = new Date(timestamp);
      return date.toLocaleTimeString('en-US', { 
        hour: 'numeric', 
        minute: '2-digit',
        hour12: true 
      });
    }

    // Event listeners
    elements.usernameInput.addEventListener('input', checkFormValid);
    elements.usernameInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') setProfile();
    });

    elements.messageInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });

    elements.messageInput.addEventListener('input', () => {
      sendTyping(true);
      clearTimeout(typingTimeout);
      typingTimeout = setTimeout(() => sendTyping(false), 1000);
    });

    // Initialize swipe gestures
    initializeSwipeGestures();

    // Initialize connection
    connect();
  </script>
</body>
</html>
