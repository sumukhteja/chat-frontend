<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>Chattie</title>
  
  <!-- Google OAuth 2.0 -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <meta name="google-signin-client_id" content="59001574467-2gf44nc69j4k8p7hlakuqed8unngn6hv.apps.googleusercontent.com">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap');
    
    html {
      height: 100%;
      width: 100%;
      overflow: hidden;
    }
    
    body { 
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
      background: #0a0a0a;
      min-height: 100vh;
      height: 100vh;
      width: 100vw;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0;
      margin: 0;
      color: #ffffff;
      overflow: hidden;
      -webkit-text-size-adjust: 100%;
      -webkit-overflow-scrolling: touch;
      position: fixed;
      top: 0;
      left: 0;
    }
    
    /* Samsung S24 Specific Optimizations */
    @media screen and (device-width: 360px) and (device-height: 780px) and (-webkit-device-pixel-ratio: 3) {
      body {
        height: 100vh;
        height: -webkit-fill-available;
      }
      
      .chat-container {
        height: 100vh !important;
        height: -webkit-fill-available !important;
        max-height: none !important;
        border-radius: 0 !important;
        width: 100vw !important;
        max-width: 100vw !important;
      }
      
      .main-container {
        height: 100vh;
        height: -webkit-fill-available;
      }
    }
    
    /* Chrome Mobile Optimizations for Perfect Fit */
    @supports (-webkit-touch-callout: none) {
      body {
        height: 100vh;
        height: -webkit-fill-available;
        min-height: -webkit-fill-available;
      }
      
      .main-container {
        height: 100vh;
        height: -webkit-fill-available;
        min-height: -webkit-fill-available;
      }
      
      @media (max-width: 768px) {
        .chat-container {
          height: 100vh !important;
          height: -webkit-fill-available !important;
          min-height: -webkit-fill-available !important;
        }
      }
    }
    
    /* Android Chrome Specific */
    @media screen and (-webkit-min-device-pixel-ratio: 1) {
      @supports (env(safe-area-inset-top)) {
        .chat-container {
          padding-top: env(safe-area-inset-top);
          padding-bottom: env(safe-area-inset-bottom);
        }
      }
    }
    
    .main-container {
      display: flex;
      width: 100%;
      height: 100vh;
      justify-content: center;
      align-items: center;
      background: #0a0a0a;
    }
    
    .chat-container {
      background: #ffffff;
      width: 420px;
      max-width: 95vw;
      height: 85vh;
      max-height: 700px;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12);
      border-radius: 16px;
      position: relative;
      border: 1px solid #e5e7eb;
    }
    
    /* Profile Setup - Modern Design */
    .profile-setup {
      padding: 24px;
      text-align: center;
      flex: 1;
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
      padding-top: 60px;
      background: #ffffff;
    }
    
    .profile-setup h3 { 
      margin-bottom: 32px; 
      color: #1f2937; 
      font-weight: 600; 
      font-size: 24px;
      letter-spacing: -0.025em;
    }
    
    .form-group { 
      margin-bottom: 24px; 
      text-align: left; 
    }
    
    .form-group label { 
      display: block; 
      margin-bottom: 8px; 
      font-weight: 500; 
      color: #374151; 
      font-size: 14px;
    }
    
    .form-group input {
      width: 100%;
      padding: 16px;
      border: 2px solid #e5e7eb;
      border-radius: 12px;
      font-size: 16px;
      font-family: 'Inter', sans-serif;
      transition: all 0.2s ease;
      background: #ffffff;
      color: #1f2937;
      font-weight: 400;
    }
    
    .form-group input:focus {
      outline: none;
      border-color: #10b981;
      box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
    }
    
    .gender-buttons {
      display: flex;
      gap: 12px;
      margin-top: 8px;
    }
    
    .gender-btn {
      flex: 1;
      padding: 16px;
      border: 2px solid #e5e7eb;
      background: #ffffff;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.2s ease;
      font-family: 'Inter', sans-serif;
      font-weight: 500;
      color: #374151;
      font-size: 16px;
      -webkit-tap-highlight-color: transparent;
    }
    
    .gender-btn:hover {
      border-color: #d1d5db;
      background: #f9fafb;
    }
    
    .gender-btn.selected {
      background: #10b981;
      color: white;
      border-color: #10b981;
    }
    
    .start-btn {
      width: 100%;
      padding: 16px;
      background: #10b981;
      color: white;
      border: none;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      margin-top: 24px;
      font-family: 'Inter', sans-serif;
      transition: all 0.2s ease;
      -webkit-tap-highlight-color: transparent;
    }
    
    .start-btn:hover {
      background: #059669;
      transform: translateY(-1px);
    }
    
    .start-btn:disabled {
      background: #d1d5db;
      cursor: not-allowed;
      transform: none;
    }
    
    .secondary-btn {
      padding: 12px 16px;
      background: #f3f4f6;
      color: #374151;
      border: 2px solid #e5e7eb;
      border-radius: 12px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      font-family: 'Inter', sans-serif;
      transition: all 0.2s ease;
      -webkit-tap-highlight-color: transparent;
    }
    
    .secondary-btn:hover {
      background: #e5e7eb;
      border-color: #d1d5db;
      transform: translateY(-1px);
    }
    
    /* Google Sign-In Button Styles */
    .google-signin-container {
      margin-bottom: 24px;
    }
    
    .google-signin-btn {
      width: 100%;
      padding: 16px;
      border: 2px solid #e5e7eb;
      background: #ffffff;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.2s ease;
      font-family: 'Inter', sans-serif;
      font-weight: 500;
      color: #374151;
      font-size: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
      -webkit-tap-highlight-color: transparent;
    }
    
    .google-signin-btn:hover {
      border-color: #d1d5db;
      background: #f9fafb;
      transform: translateY(-1px);
    }
    
    .google-signin-btn:active {
      transform: translateY(0);
    }
    
    .google-icon {
      width: 20px;
      height: 20px;
    }
    
    .divider {
      display: flex;
      align-items: center;
      margin: 24px 0;
      color: #9ca3af;
      font-size: 14px;
    }
    
    .divider::before,
    .divider::after {
      content: '';
      flex: 1;
      height: 1px;
      background: #e5e7eb;
    }
    
    .divider::before {
      margin-right: 16px;
    }
    
    .divider::after {
      margin-left: 16px;
    }
    
    .auth-section {
      margin-bottom: 24px;
    }
    
    .user-profile {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 16px;
      background: #f3f4f6;
      border-radius: 12px;
      margin-bottom: 24px;
    }
    
    .user-avatar {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      object-fit: cover;
    }
    
    .user-info h4 {
      margin: 0;
      color: #1f2937;
      font-weight: 600;
    }
    
    .user-info p {
      margin: 4px 0 0 0;
      color: #6b7280;
      font-size: 14px;
    }

    /* Main Screen Layout */
    .main-screen {
      flex: 1;
      display: flex;
      flex-direction: column;
      min-height: 0;
      overflow: hidden;
    }
    
    .waiting-screen {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      padding: 60px 24px 40px 24px;
      text-align: center;
      background: #ffffff;
    }
    
    .waiting-screen h3 { 
      color: #1f2937; 
      margin-bottom: 16px; 
      font-weight: 600;
      font-size: 20px;
    }
    
    .waiting-screen p { 
      color: #6b7280; 
      font-size: 14px;
      line-height: 1.5;
    }
    
    .spinner {
      border: 3px solid #e5e7eb;
      border-top: 3px solid #10b981;
      border-radius: 50%;
      width: 32px;
      height: 32px;
      animation: spin 1s linear infinite;
      margin-bottom: 24px;
    }
    
    @keyframes spin { 
      0% { transform: rotate(0deg); } 
      100% { transform: rotate(360deg); } 
    }
    
    /* Chat Screen - WhatsApp Style */
    .matched-screen {
      flex: 1;
      display: flex;
      flex-direction: column;
      height: 100%;
      min-height: 0;
      overflow: hidden;
      background: #f0f2f5;
    }
    
    /* Chat Header - WhatsApp Style */
    .chat-header {
      background: #ffffff;
      border-bottom: 1px solid #e5e7eb;
      padding: 16px 20px;
      display: flex;
      align-items: center;
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
      flex-shrink: 0;
      min-height: 70px;
      gap: 12px;
    }
    
    .back-btn {
      background: #f3f4f6;
      border: 1px solid #e5e7eb;
      border-radius: 50%;
      width: 44px;
      height: 44px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      cursor: pointer;
      transition: all 0.2s ease;
      flex-shrink: 0;
    }
    
    .back-btn:hover {
      background: #e5e7eb;
      border-color: #d1d5db;
    }
    
    .partner-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: linear-gradient(45deg, #10b981 0%, #059669 100%);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 16px;
      margin-right: 12px;
      flex-shrink: 0;
    }
    
    .partner-info {
      flex: 1;
      min-width: 0;
    }
    
    .partner-info h4 {
      margin: 0 0 2px 0;
      font-size: 16px;
      font-weight: 600;
      color: #1f2937;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    
    .partner-info p {
      margin: 0;
      font-size: 13px;
      color: #10b981;
      font-weight: 500;
    }
    
    .chat-call-timer {
      margin: 2px 0 0 0;
      font-size: 12px;
      color: #ef4444;
      font-weight: 600;
      background: rgba(239, 68, 68, 0.1);
      padding: 2px 6px;
      border-radius: 6px;
      display: inline-block;
    }
    
    .voice-controls {
      display: flex;
      gap: 8px;
      flex-shrink: 0;
    }
    
    .voice-btn {
      background: #f3f4f6;
      border: 1px solid #e5e7eb;
      border-radius: 50%;
      width: 44px;
      height: 44px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 20px;
      transition: all 0.2s ease;
      -webkit-tap-highlight-color: transparent;
      color: #374151;
    }
    
    .voice-btn:hover {
      background: #e5e7eb;
      transform: scale(1.05);
    }
    
    .voice-btn.active {
      background: #10b981;
      color: white;
      border-color: #10b981;
    }
    
    .voice-btn.calling {
      background: #ef4444;
      border-color: #ef4444;
      color: white;
      animation: pulse 1.5s infinite;
    }
    
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.1); }
      100% { transform: scale(1); }
    }
    
    /* Chat Messages - WhatsApp Style */
    .chat-messages {
      flex: 1;
      overflow-y: auto;
      overflow-x: hidden;
      padding: 16px;
      background: #f0f2f5;
      display: flex;
      flex-direction: column;
      gap: 2px;
      min-height: 0;
      position: relative;
      scrollbar-width: thin;
      scrollbar-color: rgba(0, 0, 0, 0.2) transparent;
    }
    
    .chat-messages::-webkit-scrollbar {
      width: 6px;
    }
    
    .chat-messages::-webkit-scrollbar-track {
      background: transparent;
    }
    
    .chat-messages::-webkit-scrollbar-thumb {
      background-color: rgba(0, 0, 0, 0.2);
      border-radius: 3px;
    }
    
    .chat-messages::-webkit-scrollbar-thumb:hover {
      background-color: rgba(0, 0, 0, 0.3);
    }
    
    .message-group {
      display: flex;
      flex-direction: column;
      margin-bottom: 16px;
      flex-shrink: 0;
    }
    
    .message-group.own {
      align-items: flex-end;
    }
    
    .message-group.other {
      align-items: flex-start;
    }
    
    .message {
      max-width: 80%;
      word-wrap: break-word;
      position: relative;
      margin: 1px 0;
      transition: transform 0.2s ease;
      overflow: hidden;
    }
    
    /* Swipe-to-Reply Functionality */
    .message-container {
      position: relative;
      display: flex;
      align-items: center;
      width: 100%;
    }
    
    .message-swipe-area {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      z-index: 1;
      opacity: 0;
      transition: opacity 0.2s ease;
    }
    
    .message-swipe-area.left {
      left: 10px;
    }
    
    .message-swipe-area.right {
      right: 10px;
    }
    
    .reply-button, .react-button, .delete-button {
      background: #10b981;
      color: white;
      border: none;
      border-radius: 50%;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);
      transition: all 0.2s ease;
    }
    
    .reply-button:hover, .react-button:hover, .delete-button:hover {
      background: #059669;
      transform: scale(1.1);
    }
    
    .delete-button {
      background: #ef4444;
      box-shadow: 0 2px 8px rgba(239, 68, 68, 0.3);
    }
    
    .delete-button:hover {
      background: #dc2626;
    }
    
    /* Message States */
    .message.swiping-left {
      transform: translateX(-50px);
    }
    
    .message.swiping-right {
      transform: translateX(50px);
    }
    
    .message.swiping-left .message-swipe-area.left,
    .message.swiping-right .message-swipe-area.right {
      opacity: 1;
    }
    
    .message.own {
      align-self: flex-end;
    }
    
    .message.other {
      align-self: flex-start;
    }
    
    .message-bubble {
      padding: 8px 12px;
      border-radius: 18px;
      position: relative;
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
    }
    
    .message.own .message-bubble {
      background: #dcf8c6;
      color: #1f2937;
    }
    
    .message.other .message-bubble {
      background: #ffffff;
      color: #1f2937;
    }
    
    .voice-note-bubble {
      min-width: 200px;
      max-width: 250px;
    }
    
    .voice-note-content {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 4px 0;
    }
    
    .voice-play-btn {
      background: rgba(255, 255, 255, 0.2);
      border: none;
      border-radius: 50%;
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 14px;
      transition: background 0.2s;
      flex-shrink: 0;
    }
    
    .voice-play-btn:hover {
      background: rgba(255, 255, 255, 0.3);
    }
    
    .message.own .voice-play-btn {
      background: rgba(255, 255, 255, 0.2);
    }
    
    .message.other .voice-play-btn {
      background: rgba(0, 0, 0, 0.1);
    }
    
    .voice-waveform {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: flex-end;
    }
    
    .voice-duration {
      font-size: 12px;
      opacity: 0.8;
      font-weight: 500;
    }
    
    .image-bubble {
      padding: 4px;
      max-width: 280px;
    }
    
    .image-container {
      position: relative;
      border-radius: 8px;
      overflow: hidden;
    }
    
    .shared-image {
      display: block;
      max-width: 100%;
      height: auto;
      transition: transform 0.2s ease;
    }
    
    .shared-image:hover {
      transform: scale(1.02);
    }
    
    .message-text {
      font-size: 14px;
      line-height: 1.4;
      margin: 0;
      font-weight: 400;
    }
    
    .message-time {
      font-size: 11px;
      opacity: 0.7;
      margin-top: 4px;
      text-align: right;
      color: #6b7280;
    }
    
    /* Reply Preview Styles */
    .reply-preview {
      background: #f0f9ff;
      border-left: 3px solid #10b981;
      padding: 8px 12px;
      margin-bottom: 8px;
      border-radius: 8px;
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 8px;
    }
    
    .reply-preview-content {
      flex: 1;
    }
    
    .reply-preview-header {
      font-size: 12px;
      font-weight: 600;
      color: #10b981;
      margin-bottom: 2px;
    }
    
    .reply-preview-text {
      font-size: 12px;
      color: #6b7280;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      max-width: 200px;
    }
    
    .reply-close-button {
      background: none;
      border: none;
      color: #9ca3af;
      cursor: pointer;
      padding: 2px;
      font-size: 16px;
      line-height: 1;
      flex-shrink: 0;
    }
    
    /* Message Replies */
    .message-reply {
      background: #f9fafb;
      border-left: 3px solid #10b981;
      padding: 6px 8px;
      margin-bottom: 6px;
      border-radius: 6px;
      font-size: 12px;
    }
    
    .message-reply-header {
      font-weight: 600;
      color: #10b981;
      margin-bottom: 2px;
    }
    
    .message-reply-text {
      color: #6b7280;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    
    /* Message Reactions */
    .message-reactions {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      margin-top: 4px;
      min-height: 0;
    }
    
    .reaction {
      background: rgba(255, 255, 255, 0.9);
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      padding: 2px 6px;
      display: flex;
      align-items: center;
      gap: 2px;
      font-size: 11px;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .reaction:hover {
      background: #f3f4f6;
      border-color: #10b981;
    }
    
    .reaction.own-reaction {
      background: #dcf8c6;
      border-color: #10b981;
    }
    
    .reaction-emoji {
      font-size: 12px;
    }
    
    .reaction-count {
      font-size: 10px;
      font-weight: 500;
      color: #6b7280;
      min-width: 8px;
    }
    
    /* Emoji Picker */
    .emoji-picker {
      position: absolute;
      background: white;
      border-radius: 20px;
      padding: 12px;
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
      z-index: 1000;
      display: none;
      max-width: 280px;
      border: 1px solid #e5e7eb;
    }
    
    .emoji-picker.show {
      display: block;
    }
    
    .emoji-picker-header {
      font-size: 12px;
      font-weight: 600;
      color: #6b7280;
      margin-bottom: 8px;
      text-align: center;
    }
    
    .emoji-picker-grid {
      display: grid;
      grid-template-columns: repeat(6, 1fr);
      gap: 8px;
    }
    
    .emoji-pick-button {
      background: none;
      border: none;
      font-size: 20px;
      padding: 8px;
      border-radius: 8px;
      cursor: pointer;
      transition: background-color 0.2s;
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .emoji-pick-button:hover {
      background: #f3f4f6;
    }
    
    /* Typing Indicator */
    .typing-indicator {
      padding: 12px 16px;
      font-style: italic;
      color: #6b7280;
      background: #f0f2f5;
      min-height: 36px;
      display: flex;
      align-items: center;
      font-size: 13px;
      flex-shrink: 0;
    }
    
    .typing-dots {
      display: inline-flex;
      align-items: center;
      gap: 2px;
      margin-left: 8px;
    }
    
    .typing-dot {
      width: 3px;
      height: 3px;
      border-radius: 50%;
      background: #6b7280;
      animation: typing-bounce 1.4s infinite ease-in-out;
    }
    
    .typing-dot:nth-child(2) { animation-delay: 0.2s; }
    .typing-dot:nth-child(3) { animation-delay: 0.4s; }
    
    @keyframes typing-bounce {
      0%, 60%, 100% { transform: translateY(0); }
      30% { transform: translateY(-4px); }
    }
    
    /* Input Area - WhatsApp Style */
    .input-area {
      display: flex;
      align-items: flex-end;
      padding: 12px;
      background: #ffffff;
      border-top: 1px solid #e5e7eb;
      gap: 8px;
      flex-shrink: 0;
      width: 100%;
      box-sizing: border-box;
      min-height: 56px;
    }
    
    .input-container {
      flex: 1;
      position: relative;
      display: flex;
      align-items: flex-end;
      background: #f3f4f6;
      border: 1px solid #e5e7eb;
      border-radius: 20px;
      padding: 6px 12px;
      transition: all 0.2s ease;
      max-height: 100px;
      min-width: 0;
      width: 100%;
      box-sizing: border-box;
    }
    
    .input-container:focus-within {
      border-color: #10b981;
      background: #ffffff;
    }
    
    .message-input {
      flex: 1;
      border: none;
      outline: none;
      font-size: 14px;
      background: transparent;
      resize: none;
      min-height: 18px;
      max-height: 80px;
      font-family: 'Inter', sans-serif;
      line-height: 1.3;
      font-weight: 400;
      color: #1f2937;
      padding: 6px 0;
      width: 100%;
      box-sizing: border-box;
      word-wrap: break-word;
      overflow-wrap: break-word;
      overflow-y: hidden;
      appearance: none;
      -webkit-appearance: none;
    }
    
    .message-input::placeholder {
      color: #9ca3af;
    }
    
    .emoji-button {
      background: none;
      border: none;
      font-size: 16px;
      cursor: pointer;
      padding: 2px;
      margin-right: 4px;
      border-radius: 50%;
      transition: background-color 0.2s;
      flex-shrink: 0;
      align-self: flex-end;
      margin-bottom: 2px;
      color: #6b7280;
      -webkit-tap-highlight-color: transparent;
      width: 24px;
      height: 24px;
    }
    
    .emoji-button:hover {
      background: #f3f4f6;
    }
    
    .voice-note-button {
      background: none;
      border: none;
      font-size: 16px;
      cursor: pointer;
      padding: 2px;
      margin-right: 4px;
      border-radius: 50%;
      transition: all 0.2s;
      flex-shrink: 0;
      align-self: flex-end;
      margin-bottom: 2px;
      color: #6b7280;
      -webkit-tap-highlight-color: transparent;
      width: 24px;
      height: 24px;
    }
    
    .voice-note-button:hover {
      background: #f3f4f6;
    }
    
    .voice-note-button.recording {
      background: #ef4444;
      color: white;
      animation: pulse 1s infinite;
    }
    
    .image-button {
      background: none;
      border: none;
      font-size: 16px;
      cursor: pointer;
      padding: 2px;
      margin-right: 4px;
      border-radius: 50%;
      transition: all 0.2s;
      flex-shrink: 0;
      align-self: flex-end;
      margin-bottom: 2px;
      color: #6b7280;
      -webkit-tap-highlight-color: transparent;
      width: 24px;
      height: 24px;
    }
    
    .image-button:hover {
      background: #f3f4f6;
    }
    
    .send-button {
      background: #10b981;
      border: none;
      color: white;
      font-weight: 600;
      font-size: 14px;
      cursor: pointer;
      padding: 8px;
      border-radius: 50%;
      transition: all 0.2s ease;
      flex-shrink: 0;
      align-self: flex-end;
      font-family: 'Inter', sans-serif;
      width: 36px;
      height: 36px;
      min-width: 36px;
      min-height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
    }
    
    .send-button:hover {
      background: #059669;
      transform: scale(1.05);
    }
    
    .send-button:disabled {
      background: #d1d5db;
      cursor: not-allowed;
      transform: none;
    }
    
    /* Mobile Text Input Enhancements */
    @media (max-width: 768px) {
      .input-area {
        position: sticky;
        bottom: 0;
        left: 0;
        right: 0;
        background: #ffffff;
        padding: 8px 12px;
        padding-bottom: max(8px, env(safe-area-inset-bottom));
        border-top: 1px solid #e5e7eb;
        display: flex;
        align-items: center;
        gap: 8px;
        z-index: 100;
        min-height: auto;
        box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
      }
      
      .input-container {
        flex: 1;
        min-width: 0;
        max-width: calc(100% - 60px);
        overflow: hidden;
      }
      
      .send-button {
        flex-shrink: 0;
        width: 44px;
        height: 44px;
        min-width: 44px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0;
      }
      
      .message-input {
        font-size: 16px;
        overflow-y: auto;
        overflow-x: hidden;
        white-space: pre-wrap;
        word-break: break-word;
        max-height: 100px;
      }
      
      /* Prevent zoom on focus for iOS */
      .message-input {
        font-size: max(16px, 1rem);
        -webkit-text-size-adjust: 100%;
        zoom: 1;
      }
    }
    
    /* Control Buttons - Hidden on Desktop, Integrated in Mobile */
    .chat-control-buttons {
      display: none;
    }
    
    .control-buttons {
      display: none;
    }
    
    .hidden { 
      display: none !important; 
    }
    
    /* Call Screen Styles - Modern Design */
    .call-screen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100vh;
      background: linear-gradient(135deg, #1f2937 0%, #111827 100%);
      z-index: 1000;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .call-container {
      text-align: center;
      color: white;
      max-width: 400px;
      width: 90%;
    }
    
    .call-header {
      margin-bottom: 48px;
    }
    
    .call-status {
      font-size: 16px;
      color: #9ca3af;
      margin-bottom: 8px;
      font-weight: 500;
    }
    
    .call-timer {
      font-size: 28px;
      font-weight: 600;
      color: white;
      font-family: 'Inter', sans-serif;
    }
    
    .call-avatar {
      margin-bottom: 48px;
    }
    
    .avatar-circle {
      width: 120px;
      height: 120px;
      border-radius: 50%;
      background: linear-gradient(45deg, #10b981 0%, #059669 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 20px;
      border: 4px solid rgba(255, 255, 255, 0.2);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    }
    
    .avatar-circle span {
      font-size: 48px;
      font-weight: 600;
      color: white;
    }
    
    .call-partner-name {
      font-size: 24px;
      font-weight: 600;
      margin-bottom: 8px;
      color: white;
    }
    
    .call-connection-status {
      font-size: 14px;
      color: #9ca3af;
      font-weight: 500;
    }
    
    .call-controls {
      display: flex;
      justify-content: center;
      gap: 24px;
    }
    
    .call-control-btn {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      border: none;
      font-size: 24px;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      -webkit-tap-highlight-color: transparent;
      -webkit-touch-callout: none;
      -webkit-user-select: none;
      -khtml-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
      touch-action: manipulation;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
    }
    
    .call-control-btn:active {
      transform: scale(0.95);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.4);
    }
    
    .mute-btn {
      background: rgba(255, 255, 255, 0.2);
      color: white;
    }
    
    .mute-btn:hover {
      background: rgba(255, 255, 255, 0.3);
    }
    
    .mute-btn.muted {
      background: #ef4444;
    }
    
    .speaker-btn {
      background: rgba(255, 255, 255, 0.2);
      color: white;
    }
    
    .speaker-btn:hover {
      background: rgba(255, 255, 255, 0.3);
    }
    
    .speaker-btn.earpiece {
      background: #3b82f6;
    }
    
    .end-call-btn {
      background: #ef4444;
      color: white;
    }
    
    .end-call-btn:hover {
      background: #dc2626;
      transform: scale(1.05);
    }
    
    /* Incoming Call Styles - Modern Design */
    .incoming-call {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100vh;
      background: linear-gradient(135deg, #1e40af 0%, #1e3a8a 100%);
      z-index: 1001;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .incoming-call-container {
      text-align: center;
      color: white;
      max-width: 400px;
      width: 90%;
    }
    
    .incoming-call-header {
      margin-bottom: 48px;
    }
    
    .incoming-call-title {
      font-size: 18px;
      color: #dbeafe;
      margin-bottom: 16px;
      font-weight: 500;
    }
    
    .ringing-animation {
      font-size: 32px;
      animation: ring 1s infinite;
    }
    
    @keyframes ring {
      0%, 100% { transform: rotate(-10deg); }
      50% { transform: rotate(10deg); }
    }
    
    .incoming-call-avatar {
      margin-bottom: 48px;
    }
    
    .incoming-call-partner-name {
      font-size: 24px;
      font-weight: 600;
      margin-bottom: 8px;
      color: white;
    }
    
    .incoming-call-status {
      font-size: 14px;
      color: #dbeafe;
      font-weight: 500;
    }
    
    .incoming-call-controls {
      display: flex;
      justify-content: center;
      gap: 48px;
    }
    
    .incoming-call-btn {
      width: 72px;
      height: 72px;
      border-radius: 50%;
      border: none;
      font-size: 28px;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      -webkit-tap-highlight-color: transparent;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    }
    
    .decline-btn {
      background: #ef4444;
      color: white;
    }
    
    .decline-btn:hover {
      background: #dc2626;
      transform: scale(1.1);
    }
    
    .answer-btn {
      background: #22c55e;
      color: white;
    }
    
    .answer-btn:hover {
      background: #16a34a;
      transform: scale(1.1);
    }
    
    /* Mobile Responsiveness - WhatsApp Style */
    @media (max-width: 768px) {
      body {
        padding: 0;
        height: 100vh;
        height: -webkit-fill-available;
      }
      
      .main-container {
        align-items: stretch;
        padding: 0;
        height: 100vh;
        height: -webkit-fill-available;
      }
      
      .chat-container {
        width: 100vw;
        height: 100vh;
        height: -webkit-fill-available;
        max-height: 100vh;
        max-height: -webkit-fill-available;
        border-radius: 0;
        border: none;
        margin: 0;
        max-width: 100vw;
      }
      
      .profile-setup {
        padding: 20px;
        padding-top: 40px;
      }
      
      .waiting-screen {
        padding: 40px 20px 40px 20px;
      }
      
      .profile-setup h3 {
        font-size: 22px;
        margin-bottom: 24px;
      }
      
      .form-group input,
      .gender-btn,
      .start-btn {
        font-size: 16px;
        padding: 18px 16px;
      }
      
      .chat-header {
        padding: 12px 16px;
        min-height: 60px;
      }
      
      .partner-avatar {
        width: 36px;
        height: 36px;
        font-size: 15px;
      }
      
      .partner-info h4 {
        font-size: 15px;
      }
      
      .partner-info p {
        font-size: 12px;
      }
      
      .voice-btn {
        width: 40px;
        height: 40px;
        font-size: 18px;
      }
      
      .chat-messages {
        padding: 12px 16px;
      }
      
      .message-bubble {
        padding: 10px 14px;
      }
      
      .message-text {
        font-size: 15px;
        line-height: 1.4;
      }
      
      .chat-messages {
        padding-bottom: 80px; /* Add space for fixed input */
      }
      
      .input-container {
        padding: 8px 14px;
      }
      
      .message-input {
        font-size: 15px;
        padding: 10px 0;
      }
      
      .send-button {
        width: 40px;
        height: 40px;
        font-size: 18px;
      }
      
      .emoji-button {
        font-size: 14px;
        padding: 2px;
        margin-right: 2px;
        width: 24px;
        height: 24px;
        flex-shrink: 0;
      }
      
      .typing-indicator {
        padding: 8px 16px;
        font-size: 12px;
      }
      
      /* Call Screen Mobile */
      .call-container {
        width: 95%;
        padding: 0 20px;
      }
      
      .avatar-circle {
        width: 100px;
        height: 100px;
      }
      
      .avatar-circle span {
        font-size: 40px;
      }
      
      .call-partner-name {
        font-size: 22px;
      }
      
      .call-timer {
        font-size: 24px;
      }
      
      .call-control-btn {
        width: 56px;
        height: 56px;
        font-size: 22px;
      }
      
      .call-controls {
        gap: 20px;
      }
      
      /* Incoming Call Mobile */
      .incoming-call-container {
        width: 95%;
        padding: 0 20px;
      }
      
      .incoming-call-btn {
        width: 64px;
        height: 64px;
        font-size: 24px;
      }
      
      .incoming-call-controls {
        gap: 40px;
      }
      
      .ringing-animation {
        font-size: 28px;
      }
      
      .incoming-call-partner-name {
        font-size: 22px;
      }
    }
    
    /* Samsung S24 and Similar High-End Android Devices */
    @media screen and (max-width: 428px) and (max-height: 926px) and (-webkit-min-device-pixel-ratio: 2.5) {
      html, body {
        height: 100vh;
        height: -webkit-fill-available;
        overflow: hidden;
      }
      
      .main-container {
        height: 100vh;
        height: -webkit-fill-available;
        padding: 0;
      }
      
      .chat-container {
        width: 100vw !important;
        height: 100vh !important;
        height: -webkit-fill-available !important;
        max-width: 100vw !important;
        max-height: 100vh !important;
        max-height: -webkit-fill-available !important;
        border-radius: 0 !important;
        border: none !important;
        margin: 0 !important;
      }
      
      .input-area {
        padding: 8px 12px;
        gap: 8px;
        position: relative;
        bottom: 0;
        background: #ffffff;
        border-top: 1px solid #e5e7eb;
        width: 100%;
        box-sizing: border-box;
        min-height: 52px;
      }
      
      .input-container {
        flex: 1;
        min-width: 0;
        max-width: calc(100% - 44px);
        padding: 4px 10px;
        border-radius: 18px;
      }
      
      .message-input {
        font-size: 16px;
        -webkit-text-size-adjust: 100%;
        padding: 4px 0;
      }
      
      .send-button {
        width: 32px;
        height: 32px;
        min-width: 32px;
        min-height: 32px;
        padding: 6px;
        font-size: 14px;
      }
      
      .chat-messages {
        padding: 12px 16px;
        padding-bottom: 8px;
      }
    }

    /* Small Mobile Devices */
    @media (max-width: 480px) {
      .chat-messages {
        padding: 8px 12px;
        padding-bottom: 4px;
      }
      
      .input-area {
        padding: 6px 10px;
        gap: 6px;
        position: relative;
        bottom: 0;
        width: 100%;
        box-sizing: border-box;
        min-height: 48px;
      }
      
      .input-container {
        flex: 1;
        min-width: 0;
        max-width: calc(100% - 36px);
        padding: 4px 8px;
        border-radius: 16px;
      }
      
      .message-input {
        font-size: 16px;
        padding: 4px 0;
      }
      
      .send-button {
        width: 28px;
        height: 28px;
        min-width: 28px;
        min-height: 28px;
        padding: 4px;
        font-size: 12px;
      }
      
      .chat-header {
        padding: 8px 12px;
      }
      
      .message {
        max-width: 85%;
      }
      
      .call-controls {
        gap: 16px;
      }
      
      .call-control-btn {
        width: 52px;
        height: 52px;
        font-size: 20px;
      }
      
      .incoming-call-controls {
        gap: 32px;
      }
      
      .incoming-call-btn {
        width: 60px;
        height: 60px;
        font-size: 22px;
      }
    }
    
    /* Call Screen Styles */
    .call-screen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100vh;
      background: linear-gradient(135deg, #1e1e1e 0%, #2d2d2d 100%);
      z-index: 1000;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .call-container {
      text-align: center;
      color: white;
      max-width: 400px;
      width: 90%;
    }
    
    .call-header {
      margin-bottom: 40px;
    }
    
    .call-status {
      font-size: 18px;
      color: #b0b0b0;
      margin-bottom: 10px;
    }
    
    .call-timer {
      font-size: 32px;
      font-weight: bold;
      color: white;
      font-family: 'Courier New', monospace;
    }
    
    .call-avatar {
      margin-bottom: 50px;
    }
    
    .avatar-circle {
      width: 150px;
      height: 150px;
      border-radius: 50%;
      background: #4a4a4a;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 20px;
      border: 4px solid #666;
    }
    
    .avatar-circle span {
      font-size: 60px;
      font-weight: bold;
      color: white;
    }
    
    .call-partner-name {
      font-size: 24px;
      font-weight: bold;
      margin-bottom: 8px;
    }
    
    .call-connection-status {
      font-size: 16px;
      color: #b0b0b0;
    }
    
    .call-controls {
      display: flex;
      justify-content: center;
      gap: 30px;
    }
    
    .call-control-btn {
      width: 70px;
      height: 70px;
      border-radius: 50%;
      border: none;
      font-size: 30px;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      -webkit-tap-highlight-color: transparent;
    }
    
    .mute-btn {
      background: #4a4a4a;
      color: white;
    }
    
    .mute-btn:hover {
      background: #5a5a5a;
    }
    
    .mute-btn.muted {
      background: #ff4444;
    }
    
    .speaker-btn {
      background: #4a4a4a;
      color: white;
    }
    
    .speaker-btn:hover {
      background: #5a5a5a;
    }
    
    .speaker-btn.earpiece {
      background: #2196F3;
    }
    
    .end-call-btn {
      background: #ff4444;
      color: white;
    }
    
    .end-call-btn:hover {
      background: #ff6666;
    }
    
    /* Responsive design */
    @media (max-width: 768px) {
      .chat-container {
        width: 100%;
        height: 100vh;
        border-radius: 0;
      }
      
      .call-container {
        width: 95%;
      }
      
      .avatar-circle {
        width: 120px;
        height: 120px;
      }
      
      .avatar-circle span {
        font-size: 48px;
      }
      
      .call-timer {
        font-size: 28px;
      }
      
      .call-control-btn {
        width: 60px;
        height: 60px;
        font-size: 24px;
      }
      
      /* Improve touch targets for mobile */
      .gender-btn {
        padding: 18px 12px;
        min-height: 60px;
      }
      
      .start-btn {
        padding: 20px 15px;
        min-height: 60px;
      }
      
      .voice-controls {
        gap: 12px;
      }
      
      .voice-btn {
        min-width: 56px;
        height: 48px;
        font-size: 20px;
        border-radius: 8px;
      }
      
      /* Improve input area for mobile */
      .input-area {
        padding: 15px;
        gap: 12px;
      }
      
      .message-input {
        min-height: 60px;
        padding: 15px;
        font-size: 16px;
      }
      
      .send-button, .emoji-button, .attach-button {
        min-width: 56px;
        min-height: 56px;
        padding: 16px;
      }
      
      /* Improve incoming call buttons for mobile */
      .incoming-call-controls {
        gap: 60px;
      }
      
      .incoming-call-btn {
        width: 90px;
        height: 90px;
        font-size: 40px;
      }
      
      /* Adjust main screen to account for floating buttons */
      .main-screen {
        min-height: auto;
      }
      
      /* Make sure control buttons container is always visible when needed */
      .control-buttons:not(.hidden) {
        display: flex !important;
      }
    }
    
    /* Incoming Call Styles */
    .incoming-call {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100vh;
      background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
      z-index: 1001;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .incoming-call-container {
      text-align: center;
      color: white;
      max-width: 400px;
      width: 90%;
    }
    
    .incoming-call-header {
      margin-bottom: 40px;
    }
    
    .incoming-call-title {
      font-size: 20px;
      color: #ecf0f1;
      margin-bottom: 15px;
    }
    
    .ringing-animation {
      font-size: 40px;
      animation: ring 1s infinite;
    }
    
    @keyframes ring {
      0%, 100% { transform: rotate(-15deg); }
      50% { transform: rotate(15deg); }
    }
    
    .incoming-call-avatar {
      margin-bottom: 50px;
    }
    
    .incoming-call-partner-name {
      font-size: 26px;
      font-weight: bold;
      margin-bottom: 8px;
    }
    
    .incoming-call-status {
      font-size: 18px;
      color: #bdc3c7;
    }
    
    .incoming-call-controls {
      display: flex;
      justify-content: center;
      gap: 50px;
    }
    
    .incoming-call-btn {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      border: none;
      font-size: 35px;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      -webkit-tap-highlight-color: transparent;
    }
    
    .decline-btn {
      background: #e74c3c;
      color: white;
    }
    
    .decline-btn:hover {
      background: #c0392b;
      transform: scale(1.1);
    }
    
    .answer-btn {
      background: #27ae60;
      color: white;
    }
    
    .answer-btn:hover {
      background: #229954;
      transform: scale(1.1);
    }
    
    /* Quiz Game Styles */
    .quiz-game-section {
      flex: 1;
      display: flex;
      flex-direction: column;
      justify-content: center;
      padding: 20px 0;
      max-width: 100%;
      width: 100%;
    }
    
    .quiz-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
    }
    
    .quiz-title {
      font-size: 20px;
      font-weight: 600;
      color: #ffffff;
      margin: 0;
      flex: 1;
      text-align: left;
    }
    
    .quiz-timer {
      background: #ef4444;
      color: white;
      padding: 8px 16px;
      border-radius: 20px;
      font-weight: 600;
      font-size: 16px;
      min-width: 60px;
      animation: pulse 1s infinite;
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }
    
    .quiz-content {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      border-radius: 20px;
      padding: 30px 20px;
      margin-bottom: 20px;
    }
    
    .quiz-question {
      font-size: 18px;
      font-weight: 500;
      color: #ffffff;
      margin-bottom: 25px;
      line-height: 1.4;
    }
    
    .quiz-options {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
      margin-bottom: 20px;
    }

    /* Mobile quiz options - 2 options only */
    @media (max-width: 768px) {
      .quiz-options {
        grid-template-columns: 1fr;
        gap: 12px;
      }
      
      .quiz-option {
        padding: 18px 15px;
        font-size: 16px;
        min-height: 60px;
        display: flex;
        align-items: center;
        justify-content: center;
      }
    }
    
    .quiz-option {
      background: rgba(255, 255, 255, 0.2);
      border: 2px solid transparent;
      color: white;
      padding: 15px 20px;
      border-radius: 12px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      text-align: center;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
    }
    
    .quiz-option:hover {
      background: rgba(255, 255, 255, 0.3);
      border-color: #10b981;
    }
    
    .quiz-option.selected {
      background: #10b981;
      border-color: #059669;
      transform: scale(1.05);
    }
    
    .quiz-option.correct {
      background: #10b981;
      border-color: #059669;
    }
    
    .quiz-option.incorrect {
      background: #ef4444;
      border-color: #dc2626;
    }
    
    .quiz-results {
      text-align: center;
    }
    
    .quiz-result-text {
      font-size: 16px;
      font-weight: 500;
      color: #10b981;
      margin-bottom: 20px;
      padding: 15px;
      background: rgba(16, 185, 129, 0.1);
      border-radius: 12px;
    }
    
    .quiz-next-btn {
      background: #10b981;
      border: none;
      color: white;
      padding: 12px 30px;
      border-radius: 25px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
    }
    
    .quiz-next-btn:hover {
      background: #059669;
      transform: translateY(-2px);
    }
    
    /* Notification Animations */
    @keyframes slideIn {
      from {
        transform: translateX(100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }
    
    @keyframes slideOut {
      from {
        transform: translateX(0);
        opacity: 1;
      }
      to {
        transform: translateX(100%);
        opacity: 0;
      }
    }
    
    /* User Profile Popup */
    .profile-popup-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10001;
      animation: fadeIn 0.3s ease-out;
    }
    
    .profile-popup {
      background: white;
      border-radius: 16px;
      padding: 24px;
      max-width: 400px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
      position: relative;
      animation: popIn 0.3s ease-out;
    }
    
    .profile-popup-header {
      display: flex;
      align-items: center;
      gap: 16px;
      margin-bottom: 20px;
      padding-bottom: 16px;
      border-bottom: 1px solid #e5e7eb;
    }
    
    .profile-popup-avatar {
      width: 64px;
      height: 64px;
      border-radius: 50%;
      background: linear-gradient(45deg, #10b981 0%, #059669 100%);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 24px;
      flex-shrink: 0;
    }
    
    .profile-popup-info h3 {
      margin: 0;
      color: #1f2937;
      font-size: 20px;
      font-weight: 600;
    }
    
    .profile-popup-info p {
      margin: 4px 0 0 0;
      color: #6b7280;
      font-size: 14px;
    }
    
    .profile-popup-actions {
      display: flex;
      gap: 12px;
      margin-top: 20px;
    }
    
    .profile-popup-btn {
      flex: 1;
      padding: 12px 20px;
      border-radius: 8px;
      font-family: 'Inter', sans-serif;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      border: none;
    }
    
    .add-friend-btn {
      background: #10b981;
      color: white;
    }
    
    .add-friend-btn:hover {
      background: #059669;
      transform: translateY(-1px);
    }
    
    .close-popup-btn {
      background: #f3f4f6;
      color: #374151;
    }
    
    .close-popup-btn:hover {
      background: #e5e7eb;
    }
    
    .clickable-username {
      cursor: pointer;
      transition: color 0.2s ease;
    }
    
    .clickable-username:hover {
      color: #10b981;
      text-decoration: underline;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    @keyframes fadeOut {
      from { opacity: 1; }
      to { opacity: 0; }
    }
    
    @keyframes popIn {
      from {
        transform: scale(0.8);
        opacity: 0;
      }
      to {
        transform: scale(1);
        opacity: 1;
      }
    }
    
    /* Friends Page Styles */
    .friends-page {
      background: white;
      border-radius: 16px;
      padding: 24px;
      max-width: 500px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
      position: relative;
      animation: popIn 0.3s ease-out;
    }
    
    .friends-page-header {
      display: flex;
      align-items: center;
      justify-content: flex-start;
      gap: 12px;
      margin-bottom: 20px;
      padding-bottom: 16px;
      border-bottom: 1px solid #e5e7eb;
    }
    
    .friends-back-btn {
      background: #f3f4f6;
      border: 1px solid #e5e7eb;
      border-radius: 50%;
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      cursor: pointer;
      transition: all 0.2s ease;
      flex-shrink: 0;
    }
    
    .friends-back-btn:hover {
      background: #e5e7eb;
      border-color: #d1d5db;
    }
    
    .friends-page-header h3 {
      margin: 0;
      color: #1f2937;
      font-size: 20px;
      font-weight: 600;
    }
    
    .friends-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    
    .friend-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 16px;
      background: #f9fafb;
      border-radius: 12px;
      border: 1px solid #e5e7eb;
      transition: all 0.2s ease;
    }
    
    .friend-item:hover {
      background: #f3f4f6;
      border-color: #d1d5db;
    }
    
    .friend-avatar {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      background: linear-gradient(45deg, #10b981 0%, #059669 100%);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 18px;
      flex-shrink: 0;
    }
    
    .friend-info {
      flex: 1;
    }
    
    .friend-info h4 {
      margin: 0;
      color: #1f2937;
      font-size: 16px;
      font-weight: 600;
    }
    
    .friend-info p {
      margin: 4px 0 0 0;
      color: #6b7280;
      font-size: 14px;
    }
    
    .friend-date {
      color: #9ca3af;
      font-size: 12px;
      text-align: right;
    }
    
    .no-friends-message {
      text-align: center;
      padding: 40px 20px;
      color: #6b7280;
    }
    
    .no-friends-message h4 {
      margin: 0 0 8px 0;
      color: #374151;
      font-size: 18px;
    }
    
    .no-friends-message p {
      margin: 0;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <div class="main-container">
    <!-- Picture Section (70% width) -->
    <!-- Chat Container (30% width) -->
    <div class="chat-container">
    
    <!-- Profile Setup Screen -->
    <div class="profile-setup" id="profileSetup">
      <h3>Welcome to Chattie</h3>
      
      <!-- Google Authentication Section -->
      <div class="auth-section" id="authSection">
        <div class="google-signin-container">
          <div id="g_id_onload"
               data-client_id="59001574467-2gf44nc69j4k8p7hlakuqed8unngn6hv.apps.googleusercontent.com"
               data-context="signin"
               data-ux_mode="popup"
               data-callback="handleCredentialResponse"
               data-auto_prompt="false">
          </div>
          <button class="google-signin-btn" id="customGoogleBtn" onclick="initiateGoogleSignIn()">
            <svg class="google-icon" viewBox="0 0 24 24">
              <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
              <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
              <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
              <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
            </svg>
            Sign in with Google
          </button>
        </div>
        
        <div class="divider">or</div>
        
        <div class="form-group">
          <label>Username:</label>
          <input id="usernameInput" placeholder="Enter your username..." maxlength="20" />
        </div>
      </div>
      
      <!-- User Profile Display (hidden initially) -->
      <div class="user-profile" id="userProfile" style="display: none;">
        <img class="user-avatar" id="userAvatar" src="" alt="User Avatar">
        <div class="user-info">
          <h4 id="userName">User Name</h4>
          <p id="userEmail">user@email.com</p>
        </div>
        <button onclick="signOut()" style="margin-left: auto; padding: 8px 16px; background: #ef4444; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px;">Sign Out</button>
      </div>
      
      <div class="form-group">
        <label>Gender:</label>
        <div class="gender-buttons">
          <button class="gender-btn" data-gender="male" onclick="selectGender('male')">Male</button>
          <button class="gender-btn" data-gender="female" onclick="selectGender('female')">Female</button>
        </div>
      </div>
      <button class="start-btn" id="startBtn" onclick="setProfile()" disabled>Start Matching</button>
      
      <div style="margin-top: 16px; display: flex; gap: 12px;">
        <button class="secondary-btn" onclick="showFriendsPage()" style="flex: 1;">
           Friends (<span id="friendsCount">0</span>)
        </button>
        <button class="secondary-btn" onclick="signOutFromProfile()" style="flex: 1; background: #fee2e2; color: #dc2626; border-color: #fecaca;">
           Sign Out
        </button>
      </div>
    </div>
    
    <!-- Main Screen -->
    <div class="main-screen hidden" id="mainScreen">
      <!-- Waiting Screen -->
      <div class="waiting-screen hidden" id="waitingScreen">
        <div class="spinner"></div>
        <h3>Looking for a match...</h3>
        <p>Please wait while we find someone for you to chat with.</p>
      </div>
      
      <!-- Matched Screen -->
      <div class="matched-screen hidden" id="matchedScreen">
        <!-- Chat Header -->
        <div class="chat-header">
          <button class="back-btn" onclick="disconnectAndGoBack()" title="Back to Main"></button>
          <div class="partner-avatar" id="partnerAvatar">?</div>
          <div class="partner-info">
            <h4 id="partnerNameHeader" class="clickable-username" onclick="showPartnerProfile()">Partner</h4>
            <p id="partnerStatus">Online</p>
            <div class="chat-call-timer hidden" id="chatCallTimer"> 00:00</div>
          </div>
          <div class="voice-controls">
            <button class="voice-btn" id="startCallBtn" onclick="startVoiceCall()" title="Start Voice Call"></button>
            <button class="voice-btn hidden" id="endCallBtn" onclick="endVoiceCall()" title="End Call"></button>
            <button class="voice-btn hidden" id="muteBtn" onclick="toggleMute()" title="Mute/Unmute"></button>
          </div>
        </div>
        
        <div class="chat-messages" id="chatMessages"></div>
        
        <div class="typing-indicator" id="typingIndicator"></div>
        
        <div class="reply-preview" id="replyPreview" style="display: none;">
          <div class="reply-preview-content">
            <div class="reply-preview-header" id="replyPreviewHeader">Replying to</div>
            <div class="reply-preview-text" id="replyPreviewText"></div>
          </div>
          <button class="reply-close-button" onclick="cancelReply()">&times;</button>
        </div>
        
        <div class="input-area">
          <div class="input-container">
            <button class="emoji-button" onclick="toggleInputEmojiPicker()"></button>
            <button class="voice-note-button" id="voiceNoteBtn" title="Hold to record voice note"></button>
            <button class="image-button" id="imageBtn" title="Share image"></button>
            <textarea class="message-input" id="messageInput" placeholder="Type a message..." rows="1"></textarea>
          </div>
          <button class="send-button" id="sendBtn" onclick="sendMessage()">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
              <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
            </svg>
          </button>
        </div>
        
        <!-- Hidden file input for image sharing -->
        <input type="file" id="imageInput" accept="image/*" capture="environment" style="display: none;" />
        
        <!-- Emoji Picker for Reactions -->
        <div class="emoji-picker" id="emojiPicker">
          <div class="emoji-picker-header">React with an emoji</div>
          <div class="emoji-picker-grid">
            <button class="emoji-pick-button" onclick="addReaction('')"></button>
            <button class="emoji-pick-button" onclick="addReaction('')"></button>
            <button class="emoji-pick-button" onclick="addReaction('')"></button>
            <button class="emoji-pick-button" onclick="addReaction('')"></button>
            <button class="emoji-pick-button" onclick="addReaction('')"></button>
            <button class="emoji-pick-button" onclick="addReaction('')"></button>
            <button class="emoji-pick-button" onclick="addReaction('')"></button>
            <button class="emoji-pick-button" onclick="addReaction('')"></button>
            <button class="emoji-pick-button" onclick="addReaction('')"></button>
            <button class="emoji-pick-button" onclick="addReaction('')"></button>
            <button class="emoji-pick-button" onclick="addReaction('')"></button>
            <button class="emoji-pick-button" onclick="addReaction('')"></button>
          </div>
        </div>
        
        <!-- Input Emoji Picker -->
        <div class="emoji-picker" id="inputEmojiPicker">
          <div class="emoji-picker-header">Add emoji to message</div>
          <div class="emoji-picker-grid">
            <button class="emoji-pick-button" onclick="insertEmoji('')"></button>
            <button class="emoji-pick-button" onclick="insertEmoji('')"></button>
            <button class="emoji-pick-button" onclick="insertEmoji('')"></button>
            <button class="emoji-pick-button" onclick="insertEmoji('')"></button>
            <button class="emoji-pick-button" onclick="insertEmoji('')"></button>
            <button class="emoji-pick-button" onclick="insertEmoji('')"></button>
            <button class="emoji-pick-button" onclick="insertEmoji('')"></button>
            <button class="emoji-pick-button" onclick="insertEmoji('')"></button>
            <button class="emoji-pick-button" onclick="insertEmoji('')"></button>
            <button class="emoji-pick-button" onclick="insertEmoji('')"></button>
            <button class="emoji-pick-button" onclick="insertEmoji('')"></button>
            <button class="emoji-pick-button" onclick="insertEmoji('')"></button>
            <button class="emoji-pick-button" onclick="insertEmoji('')"></button>
            <button class="emoji-pick-button" onclick="insertEmoji('')"></button>
            <button class="emoji-pick-button" onclick="insertEmoji('')"></button>
            <button class="emoji-pick-button" onclick="insertEmoji('')"></button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Call Screen Overlay -->
  <div class="call-screen hidden" id="callScreen">
    <div class="call-container">
      <!-- Quiz Game Interface -->
      <div class="quiz-game-section" id="quizGameSection">
        <div class="quiz-header">
          <h3 class="quiz-title" id="quizTitle">Get to Know Each Other!</h3>
          <div class="quiz-timer" id="quizTimer">30</div>
        </div>
        
        <div class="quiz-content" id="quizContent">
          <div class="quiz-question" id="quizQuestion">What's your favorite movie?</div>
          <div class="quiz-options" id="quizOptions">
            <button class="quiz-option" onclick="selectQuizAnswer(0)">Action Movies</button>
            <button class="quiz-option" onclick="selectQuizAnswer(1)">Comedy Movies</button>
            <button class="quiz-option" onclick="selectQuizAnswer(2)">Drama Movies</button>
            <button class="quiz-option" onclick="selectQuizAnswer(3)">Horror Movies</button>
          </div>
          
          <div class="quiz-results hidden" id="quizResults">
            <div class="quiz-result-text" id="quizResultText">You both chose: Comedy Movies! </div>
            <button class="quiz-next-btn" onclick="nextQuizQuestion()">Next Question</button>
          </div>
        </div>
      </div>
      
      <!-- Call Controls moved to bottom -->
      <div class="call-header">
        <div class="call-status">Voice Call</div>
        <div class="call-timer" id="callTimer">00:00</div>
      </div>
      
      <div class="call-avatar">
        <div class="avatar-circle" id="callAvatar">
          <span id="callPartnerInitial">?</span>
        </div>
        <div class="call-partner-name" id="callPartnerName">Partner</div>
        <div class="call-connection-status" id="callConnectionStatus">Connecting...</div>
      </div>
      
      <div class="call-controls">
        <button class="call-control-btn mute-btn" id="callMuteBtn" onclick="toggleMute()">
          <span id="muteIcon"></span>
        </button>
        <button class="call-control-btn speaker-btn" id="speakerBtn" onclick="toggleSpeaker()">
          <span id="speakerIcon"></span>
        </button>
        <button class="call-control-btn end-call-btn" onclick="endVoiceCall()">
          
        </button>
      </div>
    </div>
  </div>

  <!-- Incoming Call Overlay -->
  <div class="incoming-call hidden" id="incomingCall">
    <div class="incoming-call-container">
      <div class="incoming-call-header">
        <div class="incoming-call-title">Incoming Voice Call</div>
        <div class="ringing-animation"></div>
      </div>
      
      <div class="incoming-call-avatar">
        <div class="avatar-circle" id="incomingCallAvatar">
          <span id="incomingCallPartnerInitial">?</span>
        </div>
        <div class="incoming-call-partner-name" id="incomingCallPartnerName">Partner</div>
        <div class="incoming-call-status">is calling you...</div>
      </div>
      
      <div class="incoming-call-controls">
        <button class="incoming-call-btn decline-btn" onclick="declineCall()">
          
        </button>
        <button class="incoming-call-btn answer-btn" onclick="answerCall()">
          
        </button>
      </div>
    </div>
  </div>

  <script>
    // Google Authentication Variables
    let googleUser = null;
    let isGoogleAuthenticated = false;
    
    // Friend System Variables
    let friendsList = [];
    let friendRequests = [];
    
    let ws = null;
    let myId = null;
    let myUsername = null;
    let myGender = null;
    let currentState = 'profile'; // profile, online, waiting, matched
    let soundEnabled = true;
    let reconnectInterval = null;
    let typingTimeout;
    let partnerInfo = null;
    let messageGroups = [];
    let lastMessageSender = null;

    // Voice chat variables
    let localStream = null;
    let peerConnection = null;
    let isCallActive = false;
    let isMuted = false;
    let isSpeakerOn = true; // Speaker is on by default
    
    // Call screen variables
    let callStartTime = null;
    let callTimerInterval = null;
    let isIncomingCall = false;
    let callState = 'idle'; // idle, calling, ringing, connected

    // Audio system variables
    let audioContext = null;
    let incomingCallAudio = null;
    let currentRingtone = null;
    
    // Voice note recording variables
    let mediaRecorder = null;
    let recordingStream = null;
    let recordingChunks = [];
    let isRecording = false;

    const elements = {
      profileSetup: document.getElementById('profileSetup'),
      usernameInput: document.getElementById('usernameInput'),
      startBtn: document.getElementById('startBtn'),
      mainScreen: document.getElementById('mainScreen'),
      waitingScreen: document.getElementById('waitingScreen'),
      matchedScreen: document.getElementById('matchedScreen'),
      chatMessages: document.getElementById('chatMessages'),
      messageInput: document.getElementById('messageInput'),
      typingIndicator: document.getElementById('typingIndicator'),
      partnerNameHeader: document.getElementById('partnerNameHeader'),
      partnerAvatar: document.getElementById('partnerAvatar'),
      partnerStatus: document.getElementById('partnerStatus'),
      sendBtn: document.getElementById('sendBtn'),
      voiceNoteBtn: document.getElementById('voiceNoteBtn'),
      imageBtn: document.getElementById('imageBtn'),
      imageInput: document.getElementById('imageInput'),
      startCallBtn: document.getElementById('startCallBtn'),
      endCallBtn: document.getElementById('endCallBtn'),
      muteBtn: document.getElementById('muteBtn'),
      callScreen: document.getElementById('callScreen'),
      callTimer: document.getElementById('callTimer'),
      chatCallTimer: document.getElementById('chatCallTimer'),
      callAvatar: document.getElementById('callAvatar'),
      callPartnerName: document.getElementById('callPartnerName'),
      callPartnerInitial: document.getElementById('callPartnerInitial'),
      callConnectionStatus: document.getElementById('callConnectionStatus'),
      callMuteBtn: document.getElementById('callMuteBtn'),
      muteIcon: document.getElementById('muteIcon'),
      speakerBtn: document.getElementById('speakerBtn'),
      speakerIcon: document.getElementById('speakerIcon'),
      incomingCall: document.getElementById('incomingCall'),
      incomingCallAvatar: document.getElementById('incomingCallAvatar'),
      incomingCallPartnerName: document.getElementById('incomingCallPartnerName'),
      incomingCallPartnerInitial: document.getElementById('incomingCallPartnerInitial')
    };

    // Google Authentication Functions
    function handleCredentialResponse(response) {
      // Decode the JWT token
      const responsePayload = decodeJwtResponse(response.credential);
      
      googleUser = {
        id: responsePayload.sub,
        name: responsePayload.name,
        email: responsePayload.email,
        picture: responsePayload.picture
      };
      
      isGoogleAuthenticated = true;
      
      // Update the UI
      showUserProfile(googleUser);
      
      // Don't auto-fill username - let user choose their own
      // Keep username input visible and editable
      
      // Enable the start button if gender is also selected and username is filled
      checkFormValidity();
      
      console.log('Google Sign-In successful:', googleUser);
    }
    
    function decodeJwtResponse(token) {
      var base64Url = token.split('.')[1];
      var base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
      var jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
        return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
      }).join(''));
      return JSON.parse(jsonPayload);
    }
    
    function initiateGoogleSignIn() {
      google.accounts.id.prompt();
    }
    
    function showUserProfile(user) {
      const userProfile = document.getElementById('userProfile');
      const userAvatar = document.getElementById('userAvatar');
      const userName = document.getElementById('userName');
      const userEmail = document.getElementById('userEmail');
      const authSection = document.getElementById('authSection');
      
      userAvatar.src = user.picture;
      userName.textContent = user.name;
      userEmail.textContent = user.email;
      
      userProfile.style.display = 'flex';
      
      // Keep auth section visible but hide the Google sign-in button
      const googleSigninContainer = authSection.querySelector('.google-signin-container');
      if (googleSigninContainer) {
        googleSigninContainer.style.display = 'none';
      }
      
      // Hide the divider since Google sign-in is hidden
      const divider = authSection.querySelector('.divider');
      if (divider) {
        divider.style.display = 'none';
      }
    }
    
    function signOut() {
      google.accounts.id.disableAutoSelect();
      googleUser = null;
      isGoogleAuthenticated = false;
      
      // Reset UI
      const userProfile = document.getElementById('userProfile');
      const authSection = document.getElementById('authSection');
      
      userProfile.style.display = 'none';
      authSection.style.display = 'block';
      
      // Clear username input
      elements.usernameInput.value = '';
      myUsername = null;
      
      checkFormValidity();
    }
    
    function checkFormValidity() {
      const hasUsername = myUsername || elements.usernameInput.value.trim();
      const hasGender = myGender;
      elements.startBtn.disabled = !(hasUsername && hasGender);
    }
    
    // Initialize Google Sign-In when page loads
    window.addEventListener('load', function() {
      google.accounts.id.initialize({
        client_id: '59001574467-2gf44nc69j4k8p7hlakuqed8unngn6hv.apps.googleusercontent.com',
        callback: handleCredentialResponse
      });
      
      // Initialize friend system
      loadFriendsList();
      
      // Initialize voice note recording
      initializeVoiceNoteRecording();
      
      // Initialize image sharing
      initializeImageSharing();
    });

    // Friend System Functions
    function loadFriendsList() {
      const stored = localStorage.getItem('chattie_friends');
      if (stored) {
        friendsList = JSON.parse(stored);
      }
      updateFriendsCount();
    }
    
    function saveFriendsList() {
      localStorage.setItem('chattie_friends', JSON.stringify(friendsList));
    }
    
    function addFriend(partnerData) {
      // Check if already a friend
      const existingFriend = friendsList.find(friend => 
        (friend.googleId && partnerData.googleUser && friend.googleId === partnerData.googleUser.id) ||
        (friend.username === partnerData.username && friend.gender === partnerData.gender)
      );
      
      if (existingFriend) {
        showNotification('This user is already in your friends list!');
        return;
      }
      
      const newFriend = {
        username: partnerData.username,
        gender: partnerData.gender,
        googleId: partnerData.googleUser ? partnerData.googleUser.id : null,
        googleEmail: partnerData.googleUser ? partnerData.googleUser.email : null,
        googlePicture: partnerData.googleUser ? partnerData.googleUser.picture : null,
        addedDate: new Date().toISOString()
      };
      
      friendsList.push(newFriend);
      saveFriendsList();
      updateFriendsCount();
      showNotification(`${partnerData.username} has been added to your friends list!`);
    }
    
    function showNotification(message) {
      // Simple notification system
      const notification = document.createElement('div');
      notification.className = 'notification';
      notification.textContent = message;
      notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: #10b981;
        color: white;
        padding: 12px 20px;
        border-radius: 8px;
        z-index: 10000;
        font-family: 'Inter', sans-serif;
        font-size: 14px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        animation: slideIn 0.3s ease-out;
      `;
      
      document.body.appendChild(notification);
      
      setTimeout(() => {
        notification.style.animation = 'slideOut 0.3s ease-in forwards';
        setTimeout(() => {
          document.body.removeChild(notification);
        }, 300);
      }, 3000);
    }

    // Audio System Functions
    function initializeAudioContext() {
      if (!audioContext) {
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
      }
      return audioContext;
    }
    
    function createTone(frequency, duration, type = 'sine') {
      const ctx = initializeAudioContext();
      const oscillator = ctx.createOscillator();
      const gainNode = ctx.createGain();
      
      oscillator.connect(gainNode);
      gainNode.connect(ctx.destination);
      
      oscillator.frequency.value = frequency;
      oscillator.type = type;
      
      gainNode.gain.setValueAtTime(0, ctx.currentTime);
      gainNode.gain.linearRampToValueAtTime(0.3, ctx.currentTime + 0.1);
      gainNode.gain.linearRampToValueAtTime(0, ctx.currentTime + duration);
      
      oscillator.start(ctx.currentTime);
      oscillator.stop(ctx.currentTime + duration);
      
      return { oscillator, gainNode };
    }
    
    function playIncomingCallRingtone() {
      stopCurrentRingtone();
      
      const playRingSequence = () => {
        // Create a pleasant double ring pattern
        createTone(800, 0.4); // First ring
        setTimeout(() => {
          createTone(600, 0.4); // Second ring (lower pitch)
        }, 500);
      };
      
      // Play immediately, then repeat every 2 seconds
      playRingSequence();
      currentRingtone = setInterval(playRingSequence, 2000);
    }
    
    function playCallDeclinedSound() {
      stopCurrentRingtone();
      // Play a descending tone sequence for decline
      createTone(400, 0.3);
      setTimeout(() => createTone(300, 0.3), 200);
      setTimeout(() => createTone(200, 0.4), 400);
    }
    
    function playCallEndSound() {
      stopCurrentRingtone();
      // Play a simple end tone
      createTone(300, 0.5, 'square');
    }
    
    function playCallConnectedSound() {
      stopCurrentRingtone();
      // Play a pleasant connected sound
      createTone(600, 0.2);
      setTimeout(() => createTone(800, 0.3), 150);
    }
    
    function stopCurrentRingtone() {
      if (currentRingtone) {
        clearInterval(currentRingtone);
        currentRingtone = null;
      }
    }

    // Friends Page Functions
    function showFriendsPage() {
      // Remove existing popup if any
      const existingPopup = document.querySelector('.profile-popup-overlay');
      if (existingPopup) {
        document.body.removeChild(existingPopup);
      }
      
      // Create popup overlay
      const overlay = document.createElement('div');
      overlay.className = 'profile-popup-overlay';
      
      // Create friends page content
      const friendsPage = document.createElement('div');
      friendsPage.className = 'friends-page';
      
      let friendsHTML = `
        <div class="friends-page-header">
          <button class="friends-back-btn" onclick="closeFriendsPage()"></button>
          <h3> My Friends (${friendsList.length})</h3>
        </div>
      `;
      
      if (friendsList.length === 0) {
        friendsHTML += `
          <div class="no-friends-message">
            <h4>No friends yet</h4>
            <p>Start chatting and click on usernames to add friends!</p>
          </div>
        `;
      } else {
        friendsHTML += '<div class="friends-list">';
        
        friendsList.forEach(friend => {
          const addedDate = new Date(friend.addedDate).toLocaleDateString();
          let avatarContent = '';
          
          if (friend.googlePicture) {
            avatarContent = `<img src="${friend.googlePicture}" alt="${friend.username}" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">`;
          } else {
            avatarContent = friend.username.charAt(0).toUpperCase();
          }
          
          friendsHTML += `
            <div class="friend-item">
              <div class="friend-avatar">${avatarContent}</div>
              <div class="friend-info">
                <h4>${friend.username}</h4>
                <p>${friend.gender === 'male' ? 'Male' : 'Female'}${friend.googleEmail ? '  ' + friend.googleEmail : ''}</p>
              </div>
              <div class="friend-date">
                Added ${addedDate}
              </div>
            </div>
          `;
        });
        
        friendsHTML += '</div>';
      }
      
      friendsHTML += `
        <div class="profile-popup-actions" style="margin-top: 20px;">
          <button class="profile-popup-btn close-popup-btn" onclick="closeFriendsPage()">Close</button>
        </div>
      `;
      
      friendsPage.innerHTML = friendsHTML;
      overlay.appendChild(friendsPage);
      document.body.appendChild(overlay);
      
      // Close popup when clicking overlay
      overlay.addEventListener('click', (e) => {
        if (e.target === overlay) {
          closeFriendsPage();
        }
      });
    }
    
    function closeFriendsPage() {
      const popup = document.querySelector('.profile-popup-overlay');
      if (popup) {
        popup.style.animation = 'fadeOut 0.3s ease-in forwards';
        setTimeout(() => {
          if (popup.parentNode) {
            document.body.removeChild(popup);
          }
        }, 300);
      }
    }
    
    function updateFriendsCount() {
      const friendsCountElement = document.getElementById('friendsCount');
      if (friendsCountElement) {
        friendsCountElement.textContent = friendsList.length;
      }
    }

    // Profile Sign Out Function
    function signOutFromProfile() {
      // Show confirmation dialog
      if (!confirm('Are you sure you want to sign out? You will need to sign in again.')) {
        return;
      }
      
      // Sign out from Google if authenticated
      if (isGoogleAuthenticated) {
        signOut();
      }
      
      // Clear all user data
      elements.usernameInput.value = '';
      myUsername = null;
      myGender = null;
      
      // Reset gender buttons
      document.querySelectorAll('.gender-btn').forEach(btn => {
        btn.classList.remove('selected');
      });
      
      // Reset form state
      elements.startBtn.disabled = true;
      
      // Disconnect from WebSocket if connected
      if (ws) {
        ws.close();
        ws = null;
      }
      
      // Reset state
      currentState = 'profile';
      
      // Show success message
      showNotification('Successfully signed out!');
    }

    function showPartnerProfile() {
      if (!partnerInfo) return;
      
      createProfilePopup(partnerInfo);
    }
    
    function createProfilePopup(userData) {
      // Remove existing popup if any
      const existingPopup = document.querySelector('.profile-popup-overlay');
      if (existingPopup) {
        document.body.removeChild(existingPopup);
      }
      
      // Create popup overlay
      const overlay = document.createElement('div');
      overlay.className = 'profile-popup-overlay';
      
      // Create popup content
      const popup = document.createElement('div');
      popup.className = 'profile-popup';
      
      // Create avatar content
      let avatarContent = '';
      if (userData.googleUser && userData.googleUser.picture) {
        avatarContent = `<img src="${userData.googleUser.picture}" alt="${userData.username}" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">`;
      } else {
        avatarContent = userData.username.charAt(0).toUpperCase();
      }
      
      // Check if user is already a friend
      const isFriend = friendsList.some(friend => 
        (friend.googleId && userData.googleUser && friend.googleId === userData.googleUser.id) ||
        (friend.username === userData.username && friend.gender === userData.gender)
      );
      
      popup.innerHTML = `
        <div class="profile-popup-header">
          <div class="profile-popup-avatar">${avatarContent}</div>
          <div class="profile-popup-info">
            <h3>${userData.username}</h3>
            <p>${userData.gender === 'male' ? 'Male' : 'Female'}${userData.googleUser && userData.googleUser.email ? '  ' + userData.googleUser.email : ''}</p>
          </div>
        </div>
        <div class="profile-popup-actions">
          ${isFriend ? 
            '<button class="profile-popup-btn close-popup-btn" style="flex: 2;">Already Friends </button>' :
            '<button class="profile-popup-btn add-friend-btn" onclick="handleAddFriend()">Add Friend</button>'
          }
          <button class="profile-popup-btn close-popup-btn" onclick="closeProfilePopup()">Close</button>
        </div>
      `;
      
      overlay.appendChild(popup);
      document.body.appendChild(overlay);
      
      // Store current user data for add friend action
      window.currentProfileData = userData;
      
      // Close popup when clicking overlay
      overlay.addEventListener('click', (e) => {
        if (e.target === overlay) {
          closeProfilePopup();
        }
      });
    }
    
    function closeProfilePopup() {
      const popup = document.querySelector('.profile-popup-overlay');
      if (popup) {
        popup.style.animation = 'fadeOut 0.3s ease-in forwards';
        setTimeout(() => {
          if (popup.parentNode) {
            document.body.removeChild(popup);
          }
          window.currentProfileData = null;
        }, 300);
      }
    }
    
    function handleAddFriend() {
      if (window.currentProfileData) {
        addFriend(window.currentProfileData);
        closeProfilePopup();
      }
    }

    function connect() {
      ws = new WebSocket('wss://chat-backend-4tpa.onrender.com');
      
      ws.onopen = () => {
        if (reconnectInterval) {
          clearInterval(reconnectInterval);
          reconnectInterval = null;
        }
      };

      ws.onclose = () => {
        if (!reconnectInterval) {
          reconnectInterval = setInterval(connect, 3000);
        }
      };

      ws.onerror = () => {
        // Connection error handling
      };

      ws.onmessage = handleMessage;
    }

    function handleMessage(event) {
      let data;
      try { data = JSON.parse(event.data); } catch { return; }
      
      switch(data.type) {
        case 'welcome':
          myId = data.id;
          break;
          
        case 'waiting':
          currentState = 'waiting';
          showWaitingScreen();
          break;
          
        case 'matched':
          currentState = 'matched';
          partnerInfo = data.partner;
          elements.partnerNameHeader.textContent = data.partner.username;
          
          // Handle Google profile picture if available
          if (data.partner.googleUser && data.partner.googleUser.picture) {
            elements.partnerAvatar.innerHTML = `<img src="${data.partner.googleUser.picture}" alt="${data.partner.username}" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">`;
          } else {
            elements.partnerAvatar.textContent = data.partner.username[0].toUpperCase();
            elements.partnerAvatar.innerHTML = ''; // Clear any existing image
          }
          
          elements.partnerStatus.textContent = 'Online';
          showMatchedScreen();
          if (soundEnabled) playNotification();
          break;
          
        case 'message':
          displayMessage(data);
          if (!data.fromMe && soundEnabled) playNotification();
          break;
          
        case 'deleteMessage':
          handleMessageDeletion(data);
          break;
          
        case 'reaction':
          handleReactionUpdate(data);
          break;
          
        case 'voiceNote':
          displayVoiceNote(data);
          if (!data.fromMe && soundEnabled) playNotification();
          break;
          
        case 'image':
          displayImage(data);
          if (!data.fromMe && soundEnabled) playNotification();
          break;
          
        case 'typing':
          if (data.typing) {
            elements.typingIndicator.innerHTML = `
              ${partnerInfo?.username || 'Partner'} is typing
              <span class="typing-dots">
                <span class="typing-dot"></span>
                <span class="typing-dot"></span>
                <span class="typing-dot"></span>
              </span>
            `;
          } else {
            elements.typingIndicator.textContent = '';
          }
          break;
          
        case 'voiceSignal':
          handleVoiceSignal(data);
          break;
          
        case 'partnerDisconnected':
          currentState = 'online';
          endVoiceCall(); // End any active call when partner disconnects
          showDisconnectedMessage(data.message);
          showOnlineScreen();
          break;
      }
    }

    function selectGender(gender) {
      myGender = gender;
      document.querySelectorAll('.gender-btn').forEach(btn => {
        btn.classList.remove('selected');
      });
      document.querySelector(`[data-gender="${gender}"]`).classList.add('selected');
      checkFormValid();
    }

    function checkFormValid() {
      const hasUsername = isGoogleAuthenticated && googleUser ? 
        googleUser.name : elements.usernameInput.value.trim();
      elements.startBtn.disabled = !hasUsername || !myGender;
    }

    function setProfile() {
      // Always use the username input field (user's choice)
      const username = elements.usernameInput.value.trim();
      
      if (!username || !myGender) return;
      
      myUsername = username;
      
      // Send profile data to server (include Google profile info if available)
      const profileData = {
        type: 'setProfile', 
        username: myUsername,
        gender: myGender
      };
      
      // Add Google user data if authenticated
      if (isGoogleAuthenticated && googleUser) {
        profileData.googleUser = {
          id: googleUser.id,
          email: googleUser.email,
          picture: googleUser.picture,
          isGoogleAuth: true
        };
      }
      
      ws.send(JSON.stringify(profileData));
      
      currentState = 'online';
      showOnlineScreen();
      
      // Automatically start matching after profile is set
      setTimeout(() => {
        findMatch();
      }, 500);
    }

    function showOnlineScreen() {
      elements.profileSetup.classList.add('hidden');
      elements.mainScreen.classList.remove('hidden');
      elements.waitingScreen.classList.add('hidden');
      elements.matchedScreen.classList.add('hidden');
    }

    function showWaitingScreen() {
      elements.waitingScreen.classList.remove('hidden');
      elements.matchedScreen.classList.add('hidden');
    }

    function showMatchedScreen() {
      elements.waitingScreen.classList.add('hidden');
      elements.matchedScreen.classList.remove('hidden');
      // Keep stats visible on mobile for better UX
      elements.chatMessages.innerHTML = '';
      messageGroups = [];
      lastMessageSender = null;
      
      // Auto-resize textarea
      autoResizeTextarea();
      setTimeout(() => elements.messageInput.focus(), 100);
    }

    function autoResizeTextarea() {
      const textarea = elements.messageInput;
      textarea.addEventListener('input', function() {
        // Reset height to calculate new height
        this.style.height = '20px';
        // Set new height with max limit
        this.style.height = Math.min(this.scrollHeight, 80) + 'px';
        
        // Update send button state
        elements.sendBtn.disabled = !this.value.trim();
        elements.sendBtn.style.color = this.value.trim() ? '#222222' : '#cccccc';
      });
      
      // Initial state
      elements.sendBtn.disabled = true;
      elements.sendBtn.style.color = '#cccccc';
    }

    function findMatch() {
      if (!ws || ws.readyState !== WebSocket.OPEN) return;
      ws.send(JSON.stringify({ type: 'findMatch' }));
    }

    function disconnect() {
      if (!ws || ws.readyState !== WebSocket.OPEN) return;
      ws.send(JSON.stringify({ type: 'disconnect' }));
      currentState = 'online';
      showOnlineScreen();
    }

    function findNewMatch() {
      disconnect();
      setTimeout(() => findMatch(), 500);
    }
    
    function disconnectAndGoBack() {
      // End any active call first
      if (!elements.endCallBtn.classList.contains('hidden')) {
        endVoiceCall();
      }
      
      // Disconnect from current partner and go back to main online screen
      if (ws && ws.readyState === WebSocket.OPEN) {
        ws.send(JSON.stringify({ type: 'disconnect' }));
      }
      
      // Reset state and show main online screen
      currentState = 'online';
      partnerInfo = null;
      lastMessageSender = null;
      elements.chatMessages.innerHTML = '';
      showOnlineScreen();
    }
    
    function goToProfilePage() {
      // End any active call first
      if (!elements.endCallBtn.classList.contains('hidden')) {
        endVoiceCall();
      }
      
      // Disconnect from current partner
      if (ws && ws.readyState === WebSocket.OPEN) {
        ws.send(JSON.stringify({ type: 'disconnect' }));
      }
      
      // Show profile page
      showProfileSettingsPage();
    }
    
    function showProfileSettingsPage() {
      // Hide all screens
      elements.mainScreen.classList.add('hidden');
      elements.waitingScreen.classList.add('hidden');
      elements.matchedScreen.classList.add('hidden');
      elements.callScreen.classList.add('hidden');
      
      // Show profile setup but modify it for settings
      elements.profileSetup.classList.remove('hidden');
      
      // Change the UI to be a settings/profile page
      const setupElement = elements.profileSetup;
      const titleElement = setupElement.querySelector('h2');
      const buttonElement = setupElement.querySelector('.start-btn');
      
      if (titleElement) titleElement.textContent = 'Profile & Settings';
      if (buttonElement) {
        buttonElement.textContent = 'Find New Partner';
        buttonElement.onclick = () => {
          // Reset title back and start matching
          titleElement.textContent = 'Welcome to Chattie! ';
          buttonElement.textContent = 'Start Matching';
          buttonElement.onclick = setProfile;
          findMatch();
        };
      }
      
      // Add a back to landing button
      let backToLandingBtn = setupElement.querySelector('.back-to-landing-btn');
      if (!backToLandingBtn) {
        backToLandingBtn = document.createElement('button');
        backToLandingBtn.className = 'secondary-btn back-to-landing-btn';
        backToLandingBtn.textContent = ' Back to Landing';
        backToLandingBtn.style.cssText = 'width: 100%; margin-top: 12px;';
        backToLandingBtn.onclick = goBackToLanding;
        
        // Insert before the friends/sign out buttons
        const buttonsContainer = setupElement.querySelector('div[style*="margin-top: 16px"]');
        buttonsContainer.parentNode.insertBefore(backToLandingBtn, buttonsContainer);
      }
      backToLandingBtn.style.display = 'block';
    }
    
    function goBackToLanding() {
      // Reset the profile page back to original state
      const setupElement = elements.profileSetup;
      const titleElement = setupElement.querySelector('h2');
      const buttonElement = setupElement.querySelector('.start-btn');
      
      if (titleElement) titleElement.textContent = 'Welcome to Chattie! ';
      if (buttonElement) {
        buttonElement.textContent = 'Start Matching';
        buttonElement.onclick = setProfile;
      }
      
      // Hide the back to landing button
      const backToLandingBtn = setupElement.querySelector('.back-to-landing-btn');
      if (backToLandingBtn) {
        backToLandingBtn.style.display = 'none';
      }
      
      // Show the profile setup as landing
      elements.profileSetup.classList.remove('hidden');
      elements.mainScreen.classList.add('hidden');
      elements.waitingScreen.classList.add('hidden');
      elements.matchedScreen.classList.add('hidden');
      elements.callScreen.classList.add('hidden');
    }

    // Reply functionality
    let replyingTo = null;

    function cancelReply() {
      replyingTo = null;
      document.getElementById('replyPreview').style.display = 'none';
    }

    function setReply(messageData) {
      replyingTo = messageData;
      const replyPreview = document.getElementById('replyPreview');
      const replyHeader = document.getElementById('replyPreviewHeader');
      const replyText = document.getElementById('replyPreviewText');
      
      replyHeader.textContent = messageData.fromMe ? 'Replying to yourself' : 'Replying to partner';
      replyText.textContent = messageData.text;
      replyPreview.style.display = 'flex';
      
      // Focus input
      elements.messageInput.focus();
    }

    // Emoji reactions functionality
    let currentReactionMessage = null;

    function showEmojiPicker(messageElement, messageData) {
      currentReactionMessage = { element: messageElement, data: messageData };
      const picker = document.getElementById('emojiPicker');
      const rect = messageElement.getBoundingClientRect();
      
      picker.style.display = 'block';
      picker.style.position = 'fixed';
      picker.style.top = `${Math.max(10, rect.top - picker.offsetHeight - 10)}px`;
      picker.style.left = `${Math.min(window.innerWidth - 290, Math.max(10, rect.left))}px`;
      
      // Close picker when clicking outside
      document.addEventListener('click', closeEmojiPickerOnOutsideClick);
    }

    function closeEmojiPickerOnOutsideClick(event) {
      const picker = document.getElementById('emojiPicker');
      if (!picker.contains(event.target)) {
        picker.style.display = 'none';
        document.removeEventListener('click', closeEmojiPickerOnOutsideClick);
        currentReactionMessage = null;
      }
    }

    function addReaction(emoji) {
      if (!currentReactionMessage || !ws || ws.readyState !== WebSocket.OPEN) return;
      
      // Send reaction to server
      ws.send(JSON.stringify({
        type: 'reaction',
        messageId: currentReactionMessage.data.id,
        emoji: emoji
      }));
      
      // Hide picker
      document.getElementById('emojiPicker').style.display = 'none';
      currentReactionMessage = null;
      document.removeEventListener('click', closeEmojiPickerOnOutsideClick);
    }
    
    // Input Emoji Functions
    function toggleInputEmojiPicker() {
      const picker = document.getElementById('inputEmojiPicker');
      const isVisible = picker.style.display === 'block';
      
      if (isVisible) {
        picker.style.display = 'none';
        document.removeEventListener('click', closeInputEmojiPickerOnOutsideClick);
      } else {
        picker.style.display = 'block';
        
        // Position picker above the input area
        const inputArea = document.querySelector('.input-area');
        const rect = inputArea.getBoundingClientRect();
        picker.style.position = 'fixed';
        picker.style.bottom = (window.innerHeight - rect.top + 10) + 'px';
        picker.style.left = rect.left + 'px';
        picker.style.zIndex = '1000';
        
        setTimeout(() => {
          document.addEventListener('click', closeInputEmojiPickerOnOutsideClick);
        }, 100);
      }
    }
    
    function closeInputEmojiPickerOnOutsideClick(event) {
      const picker = document.getElementById('inputEmojiPicker');
      const emojiButton = document.querySelector('.emoji-button');
      
      if (!picker.contains(event.target) && event.target !== emojiButton) {
        picker.style.display = 'none';
        document.removeEventListener('click', closeInputEmojiPickerOnOutsideClick);
      }
    }
    
    function insertEmoji(emoji) {
      const messageInput = elements.messageInput;
      const cursorPos = messageInput.selectionStart;
      const textBefore = messageInput.value.substring(0, cursorPos);
      const textAfter = messageInput.value.substring(messageInput.selectionEnd);
      
      messageInput.value = textBefore + emoji + textAfter;
      messageInput.selectionStart = messageInput.selectionEnd = cursorPos + emoji.length;
      
      // Update send button state
      elements.sendBtn.disabled = !messageInput.value.trim();
      elements.sendBtn.style.color = messageInput.value.trim() ? '#222222' : '#cccccc';
      
      // Close picker
      document.getElementById('inputEmojiPicker').style.display = 'none';
      document.removeEventListener('click', closeInputEmojiPickerOnOutsideClick);
      
      // Focus back on input
      messageInput.focus();
    }
    
    // Voice Note Recording Functions
    function initializeVoiceNoteRecording() {
      const voiceBtn = elements.voiceNoteBtn;
      
      // Mouse events for desktop
      voiceBtn.addEventListener('mousedown', startVoiceRecording);
      voiceBtn.addEventListener('mouseup', stopVoiceRecording);
      voiceBtn.addEventListener('mouseleave', stopVoiceRecording);
      
      // Touch events for mobile
      voiceBtn.addEventListener('touchstart', (e) => {
        e.preventDefault();
        startVoiceRecording();
      });
      voiceBtn.addEventListener('touchend', (e) => {
        e.preventDefault();
        stopVoiceRecording();
      });
      voiceBtn.addEventListener('touchcancel', stopVoiceRecording);
    }
    
    async function startVoiceRecording() {
      if (isRecording) return;
      
      try {
        recordingStream = await navigator.mediaDevices.getUserMedia({ audio: true });
        recordingChunks = [];
        
        mediaRecorder = new MediaRecorder(recordingStream);
        
        mediaRecorder.ondataavailable = (event) => {
          if (event.data.size > 0) {
            recordingChunks.push(event.data);
          }
        };
        
        mediaRecorder.onstop = () => {
          const audioBlob = new Blob(recordingChunks, { type: 'audio/webm' });
          sendVoiceNote(audioBlob);
          recordingStream.getTracks().forEach(track => track.stop());
          recordingStream = null;
        };
        
        mediaRecorder.start();
        isRecording = true;
        
        // Update button appearance
        elements.voiceNoteBtn.classList.add('recording');
        elements.voiceNoteBtn.innerHTML = '';
        
      } catch (error) {
        console.error('Error accessing microphone:', error);
        alert('Cannot access microphone. Please check permissions.');
      }
    }
    
    function stopVoiceRecording() {
      if (!isRecording || !mediaRecorder) return;
      
      mediaRecorder.stop();
      isRecording = false;
      
      // Reset button appearance
      elements.voiceNoteBtn.classList.remove('recording');
      elements.voiceNoteBtn.innerHTML = '';
    }
    
    function sendVoiceNote(audioBlob) {
      // Convert audio blob to base64 for transmission
      const reader = new FileReader();
      reader.onloadend = () => {
        const base64Audio = reader.result.split(',')[1];
        
        if (ws && ws.readyState === WebSocket.OPEN) {
          ws.send(JSON.stringify({
            type: 'voiceNote',
            audio: base64Audio,
            duration: recordingChunks.length // Approximate duration
          }));
        }
      };
      reader.readAsDataURL(audioBlob);
    }
    
    function playVoiceNote(button, base64Audio) {
      // Convert base64 to audio blob
      const audioData = base64Audio;
      const byteCharacters = atob(audioData);
      const byteArrays = [];
      
      for (let offset = 0; offset < byteCharacters.length; offset += 512) {
        const slice = byteCharacters.slice(offset, offset + 512);
        const byteNumbers = new Array(slice.length);
        
        for (let i = 0; i < slice.length; i++) {
          byteNumbers[i] = slice.charCodeAt(i);
        }
        
        const byteArray = new Uint8Array(byteNumbers);
        byteArrays.push(byteArray);
      }
      
      const audioBlob = new Blob(byteArrays, { type: 'audio/webm' });
      const audioUrl = URL.createObjectURL(audioBlob);
      
      const audio = new Audio(audioUrl);
      
      // Update button appearance
      button.innerHTML = '';
      button.disabled = true;
      
      audio.onended = () => {
        button.innerHTML = '';
        button.disabled = false;
        URL.revokeObjectURL(audioUrl);
      };
      
      audio.onerror = () => {
        button.innerHTML = '';
        button.disabled = false;
        URL.revokeObjectURL(audioUrl);
        console.error('Error playing voice note');
      };
      
      audio.play().catch(error => {
        console.error('Error playing audio:', error);
        button.innerHTML = '';
        button.disabled = false;
        URL.revokeObjectURL(audioUrl);
      });
    }
    
    // Image Sharing Functions
    function initializeImageSharing() {
      const imageBtn = elements.imageBtn;
      const imageInput = elements.imageInput;
      
      // Click image button to trigger file input
      imageBtn.addEventListener('click', () => {
        imageInput.click();
      });
      
      // Handle file selection
      imageInput.addEventListener('change', (event) => {
        const file = event.target.files[0];
        if (file) {
          handleImageSelection(file);
        }
        // Reset input
        event.target.value = '';
      });
    }
    
    function handleImageSelection(file) {
      // Check file size (limit to 5MB)
      if (file.size > 5 * 1024 * 1024) {
        alert('Image too large. Please select an image smaller than 5MB.');
        return;
      }
      
      // Check if it's actually an image
      if (!file.type.startsWith('image/')) {
        alert('Please select a valid image file.');
        return;
      }
      
      // Read and compress the image
      const reader = new FileReader();
      reader.onload = (e) => {
        const img = new Image();
        img.onload = () => {
          const canvas = document.createElement('canvas');
          const ctx = canvas.getContext('2d');
          
          // Resize image to max 800px width while maintaining aspect ratio
          const maxWidth = 800;
          const ratio = Math.min(maxWidth / img.width, maxWidth / img.height);
          canvas.width = img.width * ratio;
          canvas.height = img.height * ratio;
          
          ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
          
          // Convert to base64 with compression
          canvas.toBlob((blob) => {
            const compressedReader = new FileReader();
            compressedReader.onload = () => {
              const base64Image = compressedReader.result.split(',')[1];
              sendImage(base64Image, canvas.width, canvas.height);
            };
            compressedReader.readAsDataURL(blob);
          }, 'image/jpeg', 0.8); // 80% quality
        };
        img.src = e.target.result;
      };
      reader.readAsDataURL(file);
    }
    
    function sendImage(base64Image, width, height) {
      if (ws && ws.readyState === WebSocket.OPEN) {
        const imageData = {
          type: 'image',
          image: base64Image,
          width: width,
          height: height,
          fromMe: true,
          timestamp: Date.now()
        };
        
        ws.send(JSON.stringify(imageData));
        
        // Display the image locally for the sender
        displayImage(imageData);
      }
    }
    
    function openImageModal(imageSrc) {
      // Create modal overlay
      const modal = document.createElement('div');
      modal.className = 'image-modal-overlay';
      modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.9);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10000;
        cursor: pointer;
      `;
      
      // Create image element
      const img = document.createElement('img');
      img.src = imageSrc;
      img.style.cssText = `
        max-width: 90%;
        max-height: 90%;
        object-fit: contain;
        border-radius: 8px;
      `;
      
      // Create close button
      const closeBtn = document.createElement('button');
      closeBtn.innerHTML = '';
      closeBtn.style.cssText = `
        position: absolute;
        top: 20px;
        right: 20px;
        background: rgba(255, 255, 255, 0.2);
        border: none;
        color: white;
        font-size: 24px;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        cursor: pointer;
        transition: background 0.2s;
      `;
      
      closeBtn.addEventListener('mouseenter', () => {
        closeBtn.style.background = 'rgba(255, 255, 255, 0.3)';
      });
      
      closeBtn.addEventListener('mouseleave', () => {
        closeBtn.style.background = 'rgba(255, 255, 255, 0.2)';
      });
      
      // Close modal function
      const closeModal = () => {
        document.body.removeChild(modal);
        document.removeEventListener('keydown', handleKeyDown);
      };
      
      // Handle escape key
      const handleKeyDown = (e) => {
        if (e.key === 'Escape') {
          closeModal();
        }
      };
      
      // Event listeners
      modal.addEventListener('click', (e) => {
        if (e.target === modal) {
          closeModal();
        }
      });
      
      closeBtn.addEventListener('click', closeModal);
      document.addEventListener('keydown', handleKeyDown);
      
      // Add elements to modal
      modal.appendChild(img);
      modal.appendChild(closeBtn);
      document.body.appendChild(modal);
    }

    // Touch gesture handling for swipe-to-reply and emoji reactions
    function initializeSwipeGestures() {
      let startX = 0;
      let startY = 0;
      let currentMessage = null;
      let isSwipeActive = false;
      let touchStartTime = 0;
      let longPressTimer = null;

      document.getElementById('chatMessages').addEventListener('touchstart', function(e) {
        const messageElement = e.target.closest('.message');
        if (!messageElement) return;
        
        startX = e.touches[0].clientX;
        startY = e.touches[0].clientY;
        currentMessage = messageElement;
        isSwipeActive = false;
        touchStartTime = Date.now();
        
        // Set up long press for reactions
        longPressTimer = setTimeout(() => {
          if (currentMessage && !isSwipeActive) {
            const messageData = JSON.parse(currentMessage.dataset.messageData || '{}');
            showEmojiPicker(currentMessage, messageData);
            // Add haptic feedback if available
            if (navigator.vibrate) {
              navigator.vibrate(50);
            }
          }
        }, 500); // 500ms long press
      });

      document.getElementById('chatMessages').addEventListener('touchmove', function(e) {
        if (!currentMessage) return;
        
        // Clear long press timer on move
        if (longPressTimer) {
          clearTimeout(longPressTimer);
          longPressTimer = null;
        }
        
        const deltaX = e.touches[0].clientX - startX;
        const deltaY = e.touches[0].clientY - startY;
        
        // Only handle horizontal swipes
        if (Math.abs(deltaY) > Math.abs(deltaX)) {
          return;
        }
        
        e.preventDefault();
        
        if (Math.abs(deltaX) > 20) {
          isSwipeActive = true;
          
          if (deltaX > 0 && deltaX < 80) {
            // Swipe right (reveal reply on left side)
            currentMessage.style.transform = `translateX(${Math.min(deltaX, 60)}px)`;
            currentMessage.classList.add('swiping-right');
            currentMessage.classList.remove('swiping-left');
          } else if (deltaX < 0 && deltaX > -80) {
            // Swipe left (reveal react on right side)
            currentMessage.style.transform = `translateX(${Math.max(deltaX, -60)}px)`;
            currentMessage.classList.add('swiping-left');
            currentMessage.classList.remove('swiping-right');
          }
        }
      });

      document.getElementById('chatMessages').addEventListener('touchend', function(e) {
        if (!currentMessage) return;
        
        // Clear long press timer
        if (longPressTimer) {
          clearTimeout(longPressTimer);
          longPressTimer = null;
        }
        
        const deltaX = e.changedTouches[0].clientX - startX;
        const touchDuration = Date.now() - touchStartTime;
        
        // Handle double tap for reactions
        if (!isSwipeActive && touchDuration < 300 && Math.abs(deltaX) < 10) {
          // Check for double tap
          if (currentMessage.lastTapTime && (Date.now() - currentMessage.lastTapTime) < 300) {
            const messageData = JSON.parse(currentMessage.dataset.messageData || '{}');
            showEmojiPicker(currentMessage, messageData);
            currentMessage.lastTapTime = 0;
          } else {
            currentMessage.lastTapTime = Date.now();
          }
        }
        
        if (isSwipeActive && Math.abs(deltaX) > 40) {
          if (deltaX > 0) {
            // Swipe right - reply
            const messageData = JSON.parse(currentMessage.dataset.messageData || '{}');
            setReply(messageData);
          } else {
            // Swipe left - react
            const messageData = JSON.parse(currentMessage.dataset.messageData || '{}');
            showEmojiPicker(currentMessage, messageData);
          }
        }
        
        // Reset message position
        currentMessage.style.transform = '';
        currentMessage.classList.remove('swiping-left', 'swiping-right');
        currentMessage = null;
        isSwipeActive = false;
        touchStartTime = 0;
      });
    }

    function sendMessage() {
      const text = elements.messageInput.value.trim();
      if (!text || !ws || ws.readyState !== WebSocket.OPEN || currentState !== 'matched') return;
      
      const messageData = {
        type: 'message',
        text: text
      };
      
      // Add reply data if replying
      if (replyingTo) {
        messageData.replyTo = replyingTo;
        cancelReply(); // Clear reply after sending
      }
      
      ws.send(JSON.stringify(messageData));
      elements.messageInput.value = '';
      elements.messageInput.style.height = '20px';
      elements.sendBtn.disabled = true;
      elements.sendBtn.style.color = '#cccccc';
      sendTyping(false);
    }

    function deleteMessage(messageId) {
      // Confirm deletion
      if (!confirm('Delete this message for both users?')) {
        return;
      }
      
      // Send delete request to server
      if (ws && ws.readyState === WebSocket.OPEN) {
        ws.send(JSON.stringify({
          type: 'deleteMessage',
          messageId: messageId
        }));
      }
      
      // Remove message from DOM immediately for better UX
      const messageElements = document.querySelectorAll('.message');
      messageElements.forEach(msgElement => {
        const msgData = JSON.parse(msgElement.dataset.messageData || '{}');
        if (msgData.id === messageId) {
          msgElement.remove();
        }
      });
    }

    function handleMessageDeletion(data) {
      const messageId = data.messageId;
      
      // Remove message from DOM
      const messageElements = document.querySelectorAll('.message');
      messageElements.forEach(msgElement => {
        const msgData = JSON.parse(msgElement.dataset.messageData || '{}');
        if (msgData.id === messageId) {
          msgElement.remove();
        }
      });
    }

    function sendTyping(isTyping) {
      if (!ws || ws.readyState !== WebSocket.OPEN || currentState !== 'matched') return;
      ws.send(JSON.stringify({ type: 'typing', typing: isTyping }));
    }

    function displayMessage(data) {
      const isOwn = data.fromMe;
      const senderChanged = lastMessageSender !== (isOwn ? 'me' : 'partner');
      
      // Create message group if sender changed or if it's been more than 5 minutes
      if (senderChanged) {
        createNewMessageGroup(isOwn);
        lastMessageSender = isOwn ? 'me' : 'partner';
      }
      
      // Add message to current group
      const messageDiv = document.createElement('div');
      messageDiv.className = `message ${isOwn ? 'own' : 'other'}`;
      
      // Generate unique message ID if not provided
      if (!data.id) {
        data.id = 'msg_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
      }
      
      // Store message data for gestures
      messageDiv.dataset.messageData = JSON.stringify(data);
      
      let messageHTML = '<div class="message-container">';
      
      // Add swipe areas
      messageHTML += `
        <div class="message-swipe-area left">
          <button class="reply-button" onclick="setReply(${escapeHtml(JSON.stringify(data))})"></button>
        </div>
        <div class="message-swipe-area right">
          <button class="react-button" onclick="showEmojiPicker(this.closest('.message'), ${escapeHtml(JSON.stringify(data))})"></button>
          ${isOwn ? `<button class="delete-button" onclick="deleteMessage('${data.id}')"></button>` : ''}
        </div>
      `;
      
      messageHTML += '<div class="message-bubble">';
      
      // Add the new message text first
      messageHTML += `<div class="message-text">${escapeHtml(data.text)}</div>`;
      
      // Add reply reference below the message (WhatsApp style)
      if (data.replyTo) {
        messageHTML += `
          <div class="message-reply">
            <div class="message-reply-header">${data.replyTo.fromMe ? 'You' : 'Partner'}</div>
            <div class="message-reply-text">${escapeHtml(data.replyTo.text)}</div>
          </div>
        `;
      }
      
      // Add reactions if any
      if (data.reactions && data.reactions.length > 0) {
        messageHTML += '<div class="message-reactions">';
        const reactionCounts = {};
        
        data.reactions.forEach(reaction => {
          reactionCounts[reaction.emoji] = reactionCounts[reaction.emoji] || { count: 0, hasOwn: false };
          reactionCounts[reaction.emoji].count++;
          if (reaction.fromMe) {
            reactionCounts[reaction.emoji].hasOwn = true;
          }
        });
        
        Object.entries(reactionCounts).forEach(([emoji, info]) => {
          messageHTML += `
            <div class="reaction ${info.hasOwn ? 'own-reaction' : ''}" onclick="addReaction('${emoji}')">
              <span class="reaction-emoji">${emoji}</span>
              <span class="reaction-count">${info.count}</span>
            </div>
          `;
        });
        
        messageHTML += '</div>';
      }
      
      messageHTML += '</div></div>'; // Close message-bubble and message-container
      
      messageDiv.innerHTML = messageHTML;
      
      // Add to current message group
      const currentGroup = elements.chatMessages.lastElementChild;
      currentGroup.appendChild(messageDiv);
      
      elements.chatMessages.scrollTop = elements.chatMessages.scrollHeight;
    }

    function createNewMessageGroup(isOwn) {
      const groupDiv = document.createElement('div');
      groupDiv.className = `message-group ${isOwn ? 'own' : 'other'}`;
      elements.chatMessages.appendChild(groupDiv);
    }

    function handleReactionUpdate(data) {
      // Find the message element by ID
      const messageElements = document.querySelectorAll('.message');
      for (let messageElement of messageElements) {
        const messageData = JSON.parse(messageElement.dataset.messageData || '{}');
        if (messageData.id === data.messageId) {
          // Update the message data with new reactions
          messageData.reactions = data.reactions;
          messageElement.dataset.messageData = JSON.stringify(messageData);
          
          // Find and update the reactions display
          const messageBubble = messageElement.querySelector('.message-bubble');
          let reactionsContainer = messageBubble.querySelector('.message-reactions');
          
          if (data.reactions && data.reactions.length > 0) {
            // Create or update reactions container
            if (!reactionsContainer) {
              reactionsContainer = document.createElement('div');
              reactionsContainer.className = 'message-reactions';
              messageBubble.appendChild(reactionsContainer);
            }
            
            // Rebuild reactions display
            const reactionCounts = {};
            data.reactions.forEach(reaction => {
              reactionCounts[reaction.emoji] = reactionCounts[reaction.emoji] || { count: 0, hasOwn: false };
              reactionCounts[reaction.emoji].count++;
              if (reaction.fromMe) {
                reactionCounts[reaction.emoji].hasOwn = true;
              }
            });
            
            let reactionsHTML = '';
            Object.entries(reactionCounts).forEach(([emoji, info]) => {
              reactionsHTML += `
                <div class="reaction ${info.hasOwn ? 'own-reaction' : ''}" onclick="addReaction('${emoji}')">
                  <span class="reaction-emoji">${emoji}</span>
                  <span class="reaction-count">${info.count}</span>
                </div>
              `;
            });
            
            reactionsContainer.innerHTML = reactionsHTML;
          } else if (reactionsContainer) {
            // Remove reactions container if no reactions
            reactionsContainer.remove();
          }
          
          break;
        }
      }
    }
    
    function displayVoiceNote(data) {
      const isOwn = data.fromMe;
      const senderChanged = lastMessageSender !== (isOwn ? 'me' : 'partner');
      
      // Create message group if sender changed
      if (senderChanged) {
        createNewMessageGroup(isOwn);
        lastMessageSender = isOwn ? 'me' : 'partner';
      }
      
      // Add voice note to current group
      const messageDiv = document.createElement('div');
      messageDiv.className = `message ${isOwn ? 'own' : 'other'}`;
      
      // Generate unique message ID if not provided
      if (!data.id) {
        data.id = 'voice_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
      }
      
      // Store message data for gestures
      messageDiv.dataset.messageData = JSON.stringify(data);
      
      let messageHTML = '<div class="message-container">';
      
      // Add swipe areas
      messageHTML += `
        <div class="message-swipe-area left">
          <button class="reply-button" onclick="setReply(${escapeHtml(JSON.stringify(data))})"></button>
        </div>
        <div class="message-swipe-area right">
          <button class="react-button" onclick="showEmojiPicker(this.closest('.message'), ${escapeHtml(JSON.stringify(data))})"></button>
          ${isOwn ? `<button class="delete-button" onclick="deleteMessage('${data.id}')"></button>` : ''}
        </div>
      `;
      
      // Voice note bubble
      messageHTML += '<div class="message-bubble voice-note-bubble">';
      messageHTML += `
        <div class="voice-note-content">
          <button class="voice-play-btn" onclick="playVoiceNote(this, '${data.audio}')" title="Play voice note">
            
          </button>
          <div class="voice-waveform">
            <span class="voice-duration">${data.duration || '0'}s</span>
          </div>
        </div>
      `;
      
      // Add timestamp
      const timestamp = new Date(data.timestamp || Date.now()).toLocaleTimeString('en-US', {
        hour: '2-digit', 
        minute: '2-digit', 
        hour12: false
      });
      messageHTML += `<div class="message-time">${timestamp}</div>`;
      
      messageHTML += '</div></div>';
      
      messageDiv.innerHTML = messageHTML;
      
      // Add to current message group
      const currentGroup = elements.chatMessages.lastElementChild;
      if (currentGroup && currentGroup.className === 'message-group') {
        currentGroup.appendChild(messageDiv);
      } else {
        elements.chatMessages.appendChild(messageDiv);
      }
      
      // Scroll to bottom
      elements.chatMessages.scrollTop = elements.chatMessages.scrollHeight;
    }
    
    function displayImage(data) {
      const isOwn = data.fromMe;
      const senderChanged = lastMessageSender !== (isOwn ? 'me' : 'partner');
      
      // Create message group if sender changed
      if (senderChanged) {
        createNewMessageGroup(isOwn);
        lastMessageSender = isOwn ? 'me' : 'partner';
      }
      
      // Add image to current group
      const messageDiv = document.createElement('div');
      messageDiv.className = `message ${isOwn ? 'own' : 'other'}`;
      
      // Generate unique message ID if not provided
      if (!data.id) {
        data.id = 'img_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
      }
      
      // Store message data for gestures
      messageDiv.dataset.messageData = JSON.stringify(data);
      
      let messageHTML = '<div class="message-container">';
      
      // Add swipe areas
      messageHTML += `
        <div class="message-swipe-area left">
          <button class="reply-button" onclick="setReply(${escapeHtml(JSON.stringify(data))})"></button>
        </div>
        <div class="message-swipe-area right">
          <button class="react-button" onclick="showEmojiPicker(this.closest('.message'), ${escapeHtml(JSON.stringify(data))})"></button>
          ${isOwn ? `<button class="delete-button" onclick="deleteMessage('${data.id}')"></button>` : ''}
        </div>
      `;
      
      // Image bubble
      messageHTML += '<div class="message-bubble image-bubble">';
      messageHTML += `
        <div class="image-container">
          <img src="data:image/jpeg;base64,${data.image}" 
               alt="Shared image" 
               class="shared-image" 
               onclick="openImageModal(this.src)"
               style="max-width: 100%; height: auto; border-radius: 8px; cursor: pointer;" />
        </div>
      `;
      
      // Add timestamp
      const timestamp = new Date(data.timestamp || Date.now()).toLocaleTimeString('en-US', {
        hour: '2-digit', 
        minute: '2-digit', 
        hour12: false
      });
      messageHTML += `<div class="message-time">${timestamp}</div>`;
      
      messageHTML += '</div></div>';
      
      messageDiv.innerHTML = messageHTML;
      
      // Add to current message group
      const currentGroup = elements.chatMessages.lastElementChild;
      if (currentGroup && currentGroup.className === 'message-group') {
        currentGroup.appendChild(messageDiv);
      } else {
        elements.chatMessages.appendChild(messageDiv);
      }
      
      // Scroll to bottom
      elements.chatMessages.scrollTop = elements.chatMessages.scrollHeight;
    }

    function showDisconnectedMessage(message) {
      const messageDiv = document.createElement('div');
      messageDiv.className = 'message';
      messageDiv.style.background = '#ffebee';
      messageDiv.style.color = '#c62828';
      messageDiv.style.textAlign = 'center';
      messageDiv.style.maxWidth = '100%';
      messageDiv.innerHTML = `<div class="message-text">${message}</div>`;
      elements.chatMessages.appendChild(messageDiv);
      elements.chatMessages.scrollTop = elements.chatMessages.scrollHeight;
    }

    function addSystemMessage(message) {
      const messageDiv = document.createElement('div');
      messageDiv.className = 'message';
      messageDiv.style.background = '#f0f0f0';
      messageDiv.style.color = '#666';
      messageDiv.style.textAlign = 'center';
      messageDiv.style.maxWidth = '100%';
      messageDiv.style.fontSize = '14px';
      messageDiv.style.padding = '8px 12px';
      messageDiv.style.margin = '5px auto';
      messageDiv.innerHTML = `<div class="message-text">${message}</div>`;
      elements.chatMessages.appendChild(messageDiv);
      elements.chatMessages.scrollTop = elements.chatMessages.scrollHeight;
    }

    function playNotification() {
      const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmLjAzuByvHZiDcIGmi67eeeTRAMUKfj8LZjHAY4kdfyz3QdB');
      audio.volume = 0.3;
      audio.play().catch(() => {});
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Voice Chat Functions
    async function startVoiceCall() {
      if (ws && ws.readyState === WebSocket.OPEN) {
        callState = 'calling';
        ws.send(JSON.stringify({
          type: 'voiceSignal',
          signalType: 'call-request'
        }));
        
        addSystemMessage(' Calling...');
        
        // Show calling state on start call button
        elements.startCallBtn.textContent = '';
        elements.startCallBtn.disabled = true;
      }
    }
    
    function showIncomingCall() {
      if (partnerInfo) {
        elements.incomingCallPartnerName.textContent = partnerInfo.username;
        
        // Handle Google profile picture for incoming call avatar
        if (partnerInfo.googleUser && partnerInfo.googleUser.picture) {
          elements.incomingCallAvatar.innerHTML = `<img src="${partnerInfo.googleUser.picture}" alt="${partnerInfo.username}" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">`;
        } else {
          elements.incomingCallPartnerInitial.textContent = partnerInfo.username.charAt(0).toUpperCase();
          elements.incomingCallAvatar.innerHTML = `<span id="incomingCallPartnerInitial">${partnerInfo.username.charAt(0).toUpperCase()}</span>`;
        }
      }
      
      isIncomingCall = true;
      callState = 'ringing';
      elements.incomingCall.classList.remove('hidden');
      
      // Start incoming call ringtone
      playIncomingCallRingtone();
    }
    
    function hideIncomingCall() {
      isIncomingCall = false;
      elements.incomingCall.classList.add('hidden');
    }
    
    async function answerCall() {
      try {
        hideIncomingCall();
        
        // Play call connected sound
        playCallConnectedSound();
        
        // Request microphone permission
        localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
        
        // Create peer connection
        peerConnection = new RTCPeerConnection({
          iceServers: [{ urls: 'stun:stun.l.google.com:19302' }]
        });
        
        // Add local stream to peer connection
        localStream.getTracks().forEach(track => {
          peerConnection.addTrack(track, localStream);
        });
        
        // Handle incoming audio stream
        peerConnection.ontrack = (event) => {
          const remoteAudio = new Audio();
          remoteAudio.srcObject = event.streams[0];
          setSpeakerMode(remoteAudio, isSpeakerOn);
          remoteAudio.play();
        };
        
        // Handle ICE candidates
        peerConnection.onicecandidate = (event) => {
          if (event.candidate && ws && ws.readyState === WebSocket.OPEN) {
            ws.send(JSON.stringify({
              type: 'voiceSignal',
              signalType: 'ice-candidate',
              candidate: event.candidate
            }));
          }
        };
        
        // Send acceptance and wait for offer
        if (ws && ws.readyState === WebSocket.OPEN) {
          ws.send(JSON.stringify({
            type: 'voiceSignal',
            signalType: 'call-accepted'
          }));
        }
        
        callState = 'connected';
        
      } catch (error) {
        console.error('Error answering call:', error);
        alert('Could not access microphone. Please check permissions.');
        declineCall();
      }
    }
    
    function declineCall() {
      hideIncomingCall();
      
      // Play call declined sound
      playCallDeclinedSound();
      
      if (ws && ws.readyState === WebSocket.OPEN) {
        ws.send(JSON.stringify({
          type: 'voiceSignal',
          signalType: 'call-declined'
        }));
      }
      
      callState = 'idle';
      addSystemMessage(' Call declined');
    }
    
    async function initiateActualCall() {
      try {
        // Request microphone permission for caller
        localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
        
        // Create peer connection
        peerConnection = new RTCPeerConnection({
          iceServers: [{ urls: 'stun:stun.l.google.com:19302' }]
        });
        
        // Add local stream to peer connection
        localStream.getTracks().forEach(track => {
          peerConnection.addTrack(track, localStream);
        });
        
        // Handle incoming audio stream
        peerConnection.ontrack = (event) => {
          const remoteAudio = new Audio();
          remoteAudio.srcObject = event.streams[0];
          setSpeakerMode(remoteAudio, isSpeakerOn);
          remoteAudio.play();
        };
        
        // Handle ICE candidates
        peerConnection.onicecandidate = (event) => {
          if (event.candidate && ws && ws.readyState === WebSocket.OPEN) {
            ws.send(JSON.stringify({
              type: 'voiceSignal',
              signalType: 'ice-candidate',
              candidate: event.candidate
            }));
          }
        };
        
        // Create and send offer
        const offer = await peerConnection.createOffer();
        await peerConnection.setLocalDescription(offer);
        
        if (ws && ws.readyState === WebSocket.OPEN) {
          ws.send(JSON.stringify({
            type: 'voiceSignal',
            signalType: 'offer',
            offer: offer
          }));
        }
        
        isCallActive = true;
        updateVoiceUI();
        showCallScreen();
        updateCallConnectionStatus('Connecting...');
        
      } catch (error) {
        console.error('Error initiating call:', error);
        alert('Could not access microphone. Please check permissions.');
      }
    }
    
    function endVoiceCall() {
      // Play call end sound
      playCallEndSound();
      
      if (localStream) {
        localStream.getTracks().forEach(track => track.stop());
        localStream = null;
      }
      
      if (peerConnection) {
        peerConnection.close();
        peerConnection = null;
      }
      
      if (ws && ws.readyState === WebSocket.OPEN) {
        ws.send(JSON.stringify({
          type: 'voiceSignal',
          signalType: 'end-call'
        }));
      }
      
      isCallActive = false;
      isMuted = false;
      callState = 'idle';
      hideIncomingCall();
      updateVoiceUI();
      hideCallScreen();
      
      // Reset call button
      elements.startCallBtn.textContent = '';
      elements.startCallBtn.disabled = false;
      
      // Add call ended message to chat if call was active
      if (callStartTime) {
        const callDuration = Math.floor((Date.now() - callStartTime) / 1000);
        const minutes = Math.floor(callDuration / 60);
        const seconds = callDuration % 60;
        
        let durationText;
        if (minutes > 0) {
          durationText = `${minutes} minute${minutes !== 1 ? 's' : ''}`;
          if (seconds > 0) {
            durationText += ` and ${seconds} second${seconds !== 1 ? 's' : ''}`;
          }
        } else {
          durationText = `${seconds} second${seconds !== 1 ? 's' : ''}`;
        }
        
        addSystemMessage(` Call ended. Duration: ${durationText}`);
      }
    }
    
    function toggleMute() {
      if (localStream) {
        localStream.getAudioTracks().forEach(track => {
          track.enabled = !track.enabled;
        });
        isMuted = !isMuted;
        updateVoiceUI();
        updateCallScreenMute();
        
        // Add haptic feedback on mobile
        if (navigator.vibrate) {
          navigator.vibrate(50);
        }
      }
    }
    
    function toggleSpeaker() {
      isSpeakerOn = !isSpeakerOn;
      updateCallScreenSpeaker();
      
      // Add haptic feedback on mobile
      if (navigator.vibrate) {
        navigator.vibrate(50);
      }
      
      // Apply speaker mode to any active remote audio
      const remoteAudios = document.querySelectorAll('audio');
      remoteAudios.forEach(audio => {
        if (audio.srcObject) {
          setSpeakerMode(audio, isSpeakerOn);
        }
      });
    }
    
    function setSpeakerMode(audioElement, useSpeaker) {
      if (audioElement.setSinkId && typeof audioElement.setSinkId === 'function') {
        // Use setSinkId if available (Chrome, Edge)
        if (useSpeaker) {
          audioElement.setSinkId('default').catch(err => {
            console.log('Could not set speaker output:', err);
          });
        } else {
          // Try to use earpiece/phone speaker (device-dependent)
          navigator.mediaDevices.enumerateDevices().then(devices => {
            const audioOutputs = devices.filter(device => device.kind === 'audiooutput');
            const earpiece = audioOutputs.find(device => 
              device.label.toLowerCase().includes('earpiece') || 
              device.label.toLowerCase().includes('phone') ||
              device.label.toLowerCase().includes('receiver')
            );
            if (earpiece) {
              audioElement.setSinkId(earpiece.deviceId).catch(err => {
                console.log('Could not set earpiece output:', err);
              });
            }
          }).catch(err => {
            console.log('Could not enumerate devices:', err);
          });
        }
      }
    }
    
    function updateVoiceUI() {
      if (isCallActive) {
        elements.startCallBtn.classList.add('hidden');
        elements.endCallBtn.classList.remove('hidden');
        elements.muteBtn.classList.remove('hidden');
        elements.startCallBtn.classList.remove('calling');
        
        if (isMuted) {
          elements.muteBtn.textContent = '';
          elements.muteBtn.classList.add('active');
        } else {
          elements.muteBtn.textContent = '';
          elements.muteBtn.classList.remove('active');
        }
      } else {
        elements.startCallBtn.classList.remove('hidden');
        elements.endCallBtn.classList.add('hidden');
        elements.muteBtn.classList.add('hidden');
        elements.startCallBtn.classList.remove('calling');
      }
    }
    
    async function handleVoiceSignal(data) {
      try {
        if (data.signalType === 'call-request') {
          // Incoming call request - show ringing UI
          showIncomingCall();
          const callerName = partnerInfo ? partnerInfo.username : 'Partner';
          addSystemMessage(` Incoming call from ${callerName}`);
          
        } else if (data.signalType === 'call-accepted') {
          // Call was accepted, start the actual WebRTC flow
          initiateActualCall();
          addSystemMessage(' Call accepted - connecting...');
          
        } else if (data.signalType === 'call-declined') {
          // Call was declined
          playCallDeclinedSound();
          callState = 'idle';
          elements.startCallBtn.textContent = '';
          elements.startCallBtn.disabled = false;
          addSystemMessage(' Call declined');
          
        } else if (data.signalType === 'offer') {
          // WebRTC offer - for call receiver
          await peerConnection.setRemoteDescription(data.offer);
          const answer = await peerConnection.createAnswer();
          await peerConnection.setLocalDescription(answer);
          
          ws.send(JSON.stringify({
            type: 'voiceSignal',
            signalType: 'answer',
            answer: answer
          }));
          
          isCallActive = true;
          updateVoiceUI();
          showCallScreen();
          updateCallConnectionStatus('Connected');
          startCallTimer();
          addSystemMessage(' Voice chat connected');
          
        } else if (data.signalType === 'answer') {
          // WebRTC answer - for call initiator
          await peerConnection.setRemoteDescription(data.answer);
          updateCallConnectionStatus('Connected');
          startCallTimer();
          addSystemMessage(' Voice chat connected');
          
        } else if (data.signalType === 'ice-candidate') {
          if (peerConnection) {
            await peerConnection.addIceCandidate(data.candidate);
          }
          
        } else if (data.signalType === 'end-call') {
          endVoiceCall();
        }
      } catch (error) {
        console.error('Error handling voice signal:', error);
      }
    }

    // Call Screen Functions
    function showCallScreen() {
      if (partnerInfo) {
        // Update call screen with partner info
        elements.callPartnerName.textContent = partnerInfo.username;
        
        // Handle Google profile picture for call screen avatar
        if (partnerInfo.googleUser && partnerInfo.googleUser.picture) {
          elements.callAvatar.innerHTML = `<img src="${partnerInfo.googleUser.picture}" alt="${partnerInfo.username}" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">`;
        } else {
          elements.callPartnerInitial.textContent = partnerInfo.username.charAt(0).toUpperCase();
          elements.callAvatar.innerHTML = `<span id="callPartnerInitial">${partnerInfo.username.charAt(0).toUpperCase()}</span>`;
        }
      }
      
      elements.callScreen.classList.remove('hidden');
      elements.callConnectionStatus.textContent = 'Connecting...';
      updateCallScreenSpeaker(); // Initialize speaker button state
    }
    
    function startCallTimer() {
      // Start call timer only when call is connected
      callStartTime = Date.now();
      callTimerInterval = setInterval(updateCallTimer, 1000);
      
      // Show chat call timer
      elements.chatCallTimer.classList.remove('hidden');
      
      // Start the quiz game
      setTimeout(() => {
        startQuiz();
      }, 2000); // Start quiz 2 seconds after call connects
    }
    
    function hideCallScreen() {
      elements.callScreen.classList.add('hidden');
      
      // Stop call timer
      if (callTimerInterval) {
        clearInterval(callTimerInterval);
        callTimerInterval = null;
      }
      callStartTime = null;
      elements.callTimer.textContent = '00:00';
      
      // Hide chat call timer
      elements.chatCallTimer.classList.add('hidden');
    }
    
    function updateCallTimer() {
      if (callStartTime) {
        const elapsed = Math.floor((Date.now() - callStartTime) / 1000);
        const minutes = Math.floor(elapsed / 60);
        const seconds = elapsed % 60;
        const timeString = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        
        elements.callTimer.textContent = timeString;
        elements.chatCallTimer.textContent = ` ${timeString}`;
      }
    }
    
    function updateCallConnectionStatus(status) {
      elements.callConnectionStatus.textContent = status;
    }
    
    function updateCallScreenMute() {
      if (isMuted) {
        elements.muteIcon.textContent = '';
        elements.callMuteBtn.classList.add('muted');
      } else {
        elements.muteIcon.textContent = '';
        elements.callMuteBtn.classList.remove('muted');
      }
    }
    
    function updateCallScreenSpeaker() {
      if (isSpeakerOn) {
        elements.speakerIcon.textContent = '';
        elements.speakerBtn.classList.remove('earpiece');
        elements.speakerBtn.title = 'Switch to Earpiece';
      } else {
        elements.speakerIcon.textContent = '';
        elements.speakerBtn.classList.add('earpiece');
        elements.speakerBtn.title = 'Switch to Speaker';
      }
    }

    // Quiz Game Functions
    let currentQuestionIndex = 0;
    let quizTimer = null;
    let timeLeft = 30;
    let userAnswer = null;
    let partnerAnswer = null;

    const quizQuestions = [
      {
        question: "What's your favorite movie genre?",
        options: ["Action Movies", "Comedy Movies", "Drama Movies", "Horror Movies"]
      },
      {
        question: "What's your ideal vacation?",
        options: ["Beach Resort", "Mountain Adventure", "City Exploration", "Home Staycation"]
      },
      {
        question: "What's your favorite food?",
        options: ["Pizza", "Sushi", "Burgers", "Pasta"]
      },
      {
        question: "What's your favorite time of day?",
        options: ["Morning", "Afternoon", "Evening", "Night"]
      },
      {
        question: "What's your favorite season?",
        options: ["Spring", "Summer", "Fall", "Winter"]
      },
      {
        question: "What's your dream job?",
        options: ["Artist/Creative", "Entrepreneur", "Teacher", "Traveler/Explorer"]
      },
      {
        question: "What's your favorite hobby?",
        options: ["Reading", "Gaming", "Sports", "Music"]
      }
    ];

    function startQuiz() {
      currentQuestionIndex = 0;
      showCurrentQuestion();
      startQuizTimer();
    }

    function showCurrentQuestion() {
      if (currentQuestionIndex >= quizQuestions.length) {
        endQuiz();
        return;
      }

      const question = quizQuestions[currentQuestionIndex];
      document.getElementById('quizQuestion').textContent = question.question;
      
      const optionsContainer = document.getElementById('quizOptions');
      optionsContainer.innerHTML = '';
      
      // On mobile, show only 2 options
      const isMobile = window.innerWidth <= 768;
      const optionsToShow = isMobile ? question.options.slice(0, 2) : question.options;
      
      optionsToShow.forEach((option, index) => {
        const button = document.createElement('button');
        button.className = 'quiz-option';
        button.textContent = option;
        button.onclick = () => selectQuizAnswer(index);
        optionsContainer.appendChild(button);
      });

      document.getElementById('quizResults').classList.add('hidden');
      userAnswer = null;
      partnerAnswer = null;
      // Mobile gets 5 seconds, desktop gets 30
      timeLeft = isMobile ? 5 : 30;
    }

    function selectQuizAnswer(answerIndex) {
      userAnswer = answerIndex;
      
      // Visual feedback
      const options = document.querySelectorAll('.quiz-option');
      options.forEach((opt, idx) => {
        opt.classList.remove('selected');
        if (idx === answerIndex) {
          opt.classList.add('selected');
        }
      });

      // Send answer to partner (simulate for now)
      const isMobile = window.innerWidth <= 768;
      const maxOptions = isMobile ? 2 : 4;
      
      setTimeout(() => {
        partnerAnswer = Math.floor(Math.random() * maxOptions); // Random partner answer
        showQuizResult();
      }, 1000);
    }

    function showQuizResult() {
      const options = document.querySelectorAll('.quiz-option');
      const question = quizQuestions[currentQuestionIndex];
      const isMobile = window.innerWidth <= 768;
      
      options.forEach((opt, idx) => {
        opt.classList.remove('selected');
        if (idx === userAnswer) {
          opt.classList.add('correct');
        }
        if (idx === partnerAnswer && idx !== userAnswer) {
          opt.classList.add('incorrect');
        }
      });

      const resultText = document.getElementById('quizResultText');
      const resultsDiv = document.getElementById('quizResults');
      
      // Get the displayed options (mobile shows only first 2)
      const displayedOptions = isMobile ? question.options.slice(0, 2) : question.options;
      
      if (userAnswer === partnerAnswer) {
        resultText.innerHTML = ` You both chose: <strong>${displayedOptions[userAnswer]}</strong>! Great minds think alike!`;
        resultText.style.color = '#10b981';
      } else {
        resultText.innerHTML = `You chose: <strong>${displayedOptions[userAnswer]}</strong><br>Partner chose: <strong>${displayedOptions[partnerAnswer]}</strong>`;
        resultText.style.color = '#f59e0b';
      }
      
      resultsDiv.classList.remove('hidden');
      clearInterval(quizTimer);
      
      // Auto-advance on mobile
      if (isMobile) {
        setTimeout(() => {
          if (currentQuestionIndex < quizQuestions.length - 1) {
            nextQuizQuestion();
          } else {
            endQuiz();
          }
        }, 2000); // Show results for 2 seconds then auto-advance
      }
    }

    function nextQuizQuestion() {
      currentQuestionIndex++;
      showCurrentQuestion();
      startQuizTimer();
    }

    function startQuizTimer() {
      const isMobile = window.innerWidth <= 768;
      timeLeft = isMobile ? 5 : 30;
      updateTimerDisplay();
      
      quizTimer = setInterval(() => {
        timeLeft--;
        updateTimerDisplay();
        
        if (timeLeft <= 0) {
          clearInterval(quizTimer);
          
          // Auto-select random answer if time runs out
          if (userAnswer === null) {
            const maxOptions = isMobile ? 2 : 4;
            selectQuizAnswer(Math.floor(Math.random() * maxOptions));
          }
          
          // Auto-advance to next question on mobile after showing results
          if (isMobile) {
            setTimeout(() => {
              if (currentQuestionIndex < quizQuestions.length - 1) {
                nextQuizQuestion();
              } else {
                endQuiz();
              }
            }, 2000); // Show results for 2 seconds then auto-advance
          }
        }
      }, 1000);
    }

    function updateTimerDisplay() {
      document.getElementById('quizTimer').textContent = timeLeft;
    }

    function endQuiz() {
      document.getElementById('quizContent').innerHTML = `
        <div style="text-align: center; padding: 40px 20px;">
          <h3 style="color: #10b981; margin-bottom: 20px;"> Quiz Complete!</h3>
          <p style="color: #ffffff; font-size: 16px; margin-bottom: 30px;">
            Great job getting to know each other! Continue your conversation in the chat.
          </p>
          <button class="quiz-next-btn" onclick="endVoiceCall()" style="background: #ef4444;">
            End Call & Continue Chat
          </button>
        </div>
      `;
      clearInterval(quizTimer);
    }

    function formatTime(timestamp) {
      if (!timestamp) return '';
      const date = new Date(timestamp);
      return date.toLocaleTimeString('en-US', { 
        hour: 'numeric', 
        minute: '2-digit',
        hour12: true 
      });
    }

    // Event listeners
    elements.usernameInput.addEventListener('input', checkFormValid);
    elements.usernameInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') setProfile();
    });

    elements.messageInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });

    elements.messageInput.addEventListener('input', () => {
      sendTyping(true);
      clearTimeout(typingTimeout);
      typingTimeout = setTimeout(() => sendTyping(false), 1000);
    });

    // Initialize swipe gestures
    initializeSwipeGestures();

    // Initialize connection
    connect();
  </script>
</body>
</html>
